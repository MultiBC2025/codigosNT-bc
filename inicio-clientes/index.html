<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel - MultiEntretenimiento BC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f4f6f8; font-family: 'Segoe UI', sans-serif; color: #1e1e2f; }
        .login-container { max-width: 450px; margin: 80px auto; padding: 20px; }
        .card-auth { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; background: white; }
        .header-logo { font-weight: bold; color: #1e1e2f; margin-bottom: 20px; font-size: 1.5rem; }
        
        .servicio-card { border: none; border-radius: 12px; margin-bottom: 15px; transition: 0.3s; border-left: 6px solid #ccc; }
        .vencido { border-left-color: #dc3545; background-color: #fff5f5; }
        .proximo { border-left-color: #ffc107; background-color: #fffdf5; }
        .activo { border-left-color: #28a745; background-color: #fafffa; }
        
        .badge-status { font-size: 0.8rem; padding: 6px 12px; border-radius: 50px; font-weight: bold; }
        .info-row { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; }
        .pin-box { background: #1e1e2f; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        h6.column-title { font-weight: bold; color: #6c757d; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div id="sectionLogin" class="container login-container">
        <div class="card-auth text-center">
            <div class="header-logo">üöÄ MultiEntretenimiento BC</div>
            <h4 class="mb-3">Bienvenido a tu Panel</h4>
            <p class="text-muted mb-4">Ingresa tu n√∫mero de WhatsApp para ver tus servicios.</p>
            <div class="input-group mb-3">
                <span class="input-group-text bg-light">+57</span>
                <input type="tel" id="inputTel" class="form-control form-control-lg" placeholder="3001234567">
            </div>
            <button onclick="verificarAcceso()" id="btnAcceder" class="btn btn-primary btn-lg w-100 shadow-sm">Consultar Mis Servicios</button>
        </div>
    </div>

    <div id="sectionPanel" class="container mt-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 id="txtSaludo" class="mb-0">¬°Hola!</h3>
                <small class="text-muted">Estado de tus suscripciones</small>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">Cerrar Sesi√≥n</button>
        </div>

        <div id="listaServicios" class="row"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBZKmJQ7TcszQeBu--3jK4sxA3F3tAF_N8", 
        authDomain: "panel-cuentas-clientes.firebaseapp.com", 
        projectId: "panel-cuentas-clientes" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function formatearDiasTexto(diff) {
        if (diff > 5) return "Vence en " + diff + "d";
        if (diff > 0 && diff <= 5) return "Pr√≥ximo a vencer (" + diff + "d)";
        if (diff === 0) return "Vence Hoy";
        if (diff === -1) return "Venci√≥ Ayer";
        if (diff < -1) return "Venci√≥ hace " + Math.abs(diff) + "d";
        return diff + "d";
    }

    async function verificarAcceso() {
        const tel = document.getElementById("inputTel").value.trim();
        if(!tel) return alert("Ingresa tu n√∫mero.");
        const btn = document.getElementById("btnAcceder");
        btn.disabled = true;
        btn.innerText = "Buscando...";

        try {
            const snapClientes = await db.collection("clientes").get();
            let clienteEncontrado = null;
            snapClientes.forEach(doc => {
                const c = doc.data();
                const numBD = c.whatsapp.replace(/\D/g, '');
                const numInput = tel.replace(/\D/g, '');
                if(numBD.includes(numInput) && numInput.length >= 7) clienteEncontrado = { id: doc.id, ...c };
            });

            if(clienteEncontrado) cargarPanelCliente(clienteEncontrado);
            else {
                alert("N√∫mero no registrado.");
                btn.disabled = false;
                btn.innerText = "Consultar Mis Servicios";
            }
        } catch (e) { alert("Error: " + e.message); }
    }

    async function cargarPanelCliente(cliente) {
        const hoyLocal = new Date();
        hoyLocal.setHours(0,0,0,0);

        document.getElementById("sectionLogin").style.display = "none";
        document.getElementById("sectionPanel").style.display = "block";
        document.getElementById("txtSaludo").innerText = `¬°Hola, ${cliente.nombre}! üëã`;

        const contenedorPrincipal = document.getElementById("listaServicios");
        contenedorPrincipal.innerHTML = "<div class='text-center py-5'><p>Cargando servicios...</p></div>";

        try {
            const snapCuentas = await db.collection("cuentas").where("clienteId", "==", cliente.id).get();
            const snapBase = await db.collection("cuentas_base").get();
            const modsBase = {};
            snapBase.forEach(doc => { modsBase[doc.data().correo] = doc.data().ultimaModificacion; });

            let servicios = [];
            snapCuentas.forEach(doc => {
                const d = doc.data();
                const fVenceObj = new Date(d.fin + "T12:00:00");
                const diff = Math.ceil((fVenceObj - hoyLocal) / (1000 * 60 * 60 * 24)) - 1;
                
                // --- CAMBIO SOLICITADO: Ocultar si tiene m√°s de 20 d√≠as de vencido ---
                // Solo entran servicios activos o vencidos hasta por 20 d√≠as (diff >= -20)
                if (diff >= -20) {
                    servicios.push({ ...d, diff });
                }
            });

            const generarHTML = (s) => {
                const badgeColor = s.diff < 0 ? "bg-danger" : (s.diff <= 5 ? "bg-warning text-dark" : "bg-success");
                const colorClase = s.diff < 0 ? "vencido" : (s.diff <= 5 ? "proximo" : "activo");
                const fInicioFormat = s.inicio.split('-').reverse().join('/');
                const fFinFormat = s.fin.split('-').reverse().join('/');
                const tMod = modsBase[s.correo];
                const fMod = tMod ? new Date(tMod).toLocaleString('es-CO', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : "Recientemente";

                // Seguridad: Ocultar clave si venci√≥
                const mostrarClave = s.diff < 0 ? '<span class="text-danger fw-bold">Renueva para ver clave</span>' : s.clave;

                let botonRenovacion = "";
                if (s.diff <= 3) {
                    const textoE = s.diff > 0 ? `Vence en ${s.diff} dias` : (s.diff === 0 ? "Vence HOY" : `Vencio hace ${Math.abs(s.diff)} dias`);
                    const msj = encodeURIComponent(`SOLICITUD DE RENOVACION\n--------------------------\nServicio: ${s.plataforma}\nCorreo: ${s.correo}\nEstado: ${textoE}\nCliente: ${cliente.nombre}\n--------------------------\n`);
                    botonRenovacion = `<div class="mt-3"><a href="https://wa.me/573503938788?text=${msj}" target="_blank" class="btn btn-success w-100 fw-bold shadow-sm" style="background-color: #25d366; border: none;">RENOVAR POR WHATSAPP</a></div>`;
                }

                return `
                <div class="card servicio-card shadow-sm ${colorClase} mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h4 class="mb-0 text-uppercase"><b>${s.plataforma}</b></h4>
                            <span class="badge badge-status ${badgeColor}">${formatearDiasTexto(s.diff)}</span>
                        </div>
                        <div class="row mb-3 text-center">
                            <div class="col-6 border-end"><small class="text-muted d-block">INICIO</small><b>${fInicioFormat}</b></div>
                            <div class="col-6"><small class="text-muted d-block">VENCIMIENTO</small><b class="${s.diff < 0 ? 'text-danger' : ''}" style="font-size: 1.3rem;">${fFinFormat}</b></div>
                        </div>
                        <div class="info-row border rounded p-3 mb-3 bg-light">
                            <p class="mb-2">üìß <b>Correo:</b> ${s.correo}</p>
                            <p class="mb-0">üîë <b>Clave:</b> ${mostrarClave}</p>
                        </div>
                        <div class="d-flex justify-content-between text-center">
                            <div class="p-2 border rounded bg-white flex-fill me-1"><small class="text-muted d-block">PERFIL</small><b>${s.perfil}</b></div>
                            <div class="p-2 border rounded bg-white flex-fill ms-1"><small class="text-muted d-block">PIN</small><span class="pin-box">${s.pin}</span></div>
                        </div>
                        ${botonRenovacion}
                        <div class="pt-3 mt-3 border-top"><small class="text-muted" style="font-size: 0.7rem;">üìå √öltima modificaci√≥n: ${fMod}</small></div>
                    </div>
                </div>`;
            };

            // Ordenamiento y Columnas
            const proximos = servicios.filter(s => s.diff >= 0 && s.diff <= 5).sort((a,b) => a.diff - b.diff);
            const vencidos = servicios.filter(s => s.diff < 0).sort((a,b) => b.diff - a.diff);
            const vigentes = servicios.filter(s => s.diff > 5).sort((a,b) => b.fechaRegistro - a.fechaRegistro);

            const colIzquierda = document.createElement("div"); colIzquierda.className = "col-lg-6";
            const colDerecha = document.createElement("div"); colDerecha.className = "col-lg-6";

            let htmlI = "<h6 class='column-title'>‚ö†Ô∏è Prioridad (Por vencer / Vencidos)</h6>";
            proximos.forEach(s => htmlI += generarHTML(s));
            vencidos.forEach(s => htmlI += generarHTML(s));
            colIzquierda.innerHTML = htmlI;

            let htmlD = "<h6 class='column-title'>‚úÖ Servicios Activos</h6>";
            vigentes.forEach(s => htmlD += generarHTML(s));
            colDerecha.innerHTML = htmlD;

            contenedorPrincipal.innerHTML = "";
            contenedorPrincipal.appendChild(colIzquierda);
            contenedorPrincipal.appendChild(colDerecha);

        } catch (e) { contenedorPrincipal.innerHTML = "<div class='alert alert-danger'>Error: " + e.message + "</div>"; }
    }
</script>
</body>
</html>
