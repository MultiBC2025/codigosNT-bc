<html>

<head>
    <title>Panel MultiBC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="margin:0; background:#000; display:flex; justify-content:center;",><iframe srcdoc="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;es&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
&lt;title&gt;Panel Administrativo - Premium&lt;/title&gt;
<!-- TODO TU C√ìDIGO SIGUE IGUAL, NO SE TOCA -->
&lt;/head&gt;
&lt;body&gt;

&lt;div id=&quot;modalEditarCuenta&quot; style=&quot;
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.6);
    z-index:9999;
&quot;&gt;

    &lt;div style=&quot;
        width:420px;
        max-width:90%;
        margin:10% auto;
        background:#111;
        padding:20px;
        border-radius:8px;
        color:#fff;
    &quot;&gt;

        &lt;h3 style=&quot;margin-top:0&quot;&gt;‚úèÔ∏è Editar Servicio&lt;/h3&gt;

        &lt;input type=&quot;hidden&quot; id=&quot;editBaseId&quot;&gt;

        &lt;label&gt;Correo / Usuario&lt;/label&gt;
        &lt;input id=&quot;modalCorreo&quot; style=&quot;width:100%; margin-bottom:10px;&quot;&gt;

        &lt;label&gt;Clave&lt;/label&gt;
        &lt;input id=&quot;modalClave&quot; style=&quot;width:100%; margin-bottom:15px;&quot;&gt;

        &lt;div style=&quot;text-align:right&quot;&gt;
            &lt;button onclick=&quot;cerrarModalEditarCuenta()&quot; class=&quot;delete-btn&quot;&gt;Cancelar&lt;/button&gt;
            &lt;button onclick=&quot;guardarEdicionModal()&quot; class=&quot;save-btn&quot; style=&quot;margin-left:10px;&quot;&gt;Guardar&lt;/button&gt;
        &lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;


&lt;/body&gt;
&lt;/html&gt;   

&lt;script src=&quot;https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js&quot;&gt;&lt;/script&gt;
&lt;style&gt;
    body{margin:0;font-family:'Segoe UI', sans-serif;background:#f4f6f8;font-size:18px;}
    #login,#panel{display:none}
    .sidebar{width:230px;background:#1e1e2f;height:100vh;position:fixed;color:#fff;z-index: 100;}
    .sidebar h2{text-align:center;padding:15px; border-bottom: 3px solid #333; font-size: 1.3em;}
    .sidebar button{width:100%;padding:14px;border:none;background:none;color:#fff;cursor:pointer;text-align:left;padding-left:20px;transition: 0.3s;}
    .sidebar button:hover{background:#3d3d5c}
    .content{margin-left:230px;padding:20px}
    input,select{padding:10px; margin: 4px; border: 1px solid #ccc; border-radius: 6px;}
    .section{background:#fff;padding:20px;margin-bottom:25px;border:1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    table{width:100%; border-collapse:collapse; font-size:15px; background: #fff; margin-bottom: 20px;}
    th,td{border:1px solid #ddd; padding:12px; text-align:center; position: relative;}
    th.sortable { cursor: pointer; background: #ececf6; transition: 0.2s; user-select: none; }
    th.sortable:hover { background: #dcdce9; color: #007bff; }
    
    
    /* =========================
   üì± RESPONSIVE CELULAR
   ========================= */
@media (max-width: 768px) {
    .service-count {
        width: 20px;
        height: 20px;
        font-size: 10px;
        margin-right: 6px;
    }

    /* --- SIDEBAR --- */
    .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        display: flex;
        flex-wrap: wrap;
    }

    .sidebar h2 {
        width: 100%;
        text-align: center;
        font-size: 1rem;
    }

    .sidebar button {
        flex: 1 1 50%;
        text-align: center;
        padding: 12px;
        font-size: 13px;
    }

    /* --- CONTENIDO --- */
    .content {
        margin-left: 0;
        padding: 10px;
    }

    h3 {
        font-size: 16px;
        text-align: center;
    }

    h4 {
        font-size: 14px;
    }

    /* --- FORMULARIOS --- */
    input, select, button {
        width: 100% !important;
        margin: 6px 0;
        font-size: 14px;
    }

    .section {
        padding: 12px;
    }

    /* --- GRID A UNA COLUMNA --- */
    div[style*=&quot;grid-template-columns&quot;] {
        grid-template-columns: 1fr !important;
    }

    /* --- TABLAS --- */
    table {
        font-size: 12px;
    }

    th, td {
        padding: 8px;
    }

    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    /* --- BOTONES DE ACCI√ìN --- */
    .edit-btn,
    .delete-btn,
    .renew-btn {
        width: 42px;
        height: 42px;
        font-size: 16px;
    }

    /* --- BADGES / PERFILES --- */
    .badge-service {
        font-size: 12px;
        padding: 6px 10px;
        margin: 3px;
    }

    .celda-perfil {
        min-width: 70px;
        height: 45px;
        font-size: 13px;
    }

    /* --- TOOLTIP --- */
    #tooltip-flotante {
        font-size: 11px;
        max-width: 90vw;
    }
}

    
    .service-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        color: #fff;
        font-weight: bold;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        margin-right: 10px;
        font-size: 11px;
    }

    .row-finalizada-color { background-color: #e8daff !important; color: #512da8 !important; border-left: 5px solid #673ab7; }
    .row-selected-renew { background-color: #cfe2ff !important; border: 2px solid #0d6efd !important; }
    .row-vencido { background-color: #ffdce0 !important; color: #af0808; }
    .row-proximo { background-color: #fff3cd !important; color: #856404; }
    .row-activo { background-color: #d4edda !important; color: #155724; }
    
    .status-vencido { font-weight: bold; color: #dc3545; }
    .status-proximo { font-weight: bold; color: #856404; }
    .status-activo { font-weight: bold; color: #28a745; }

    .badge-service { display: inline-block; padding: 8px 14px; border-radius: 6px; font-size: 17px; margin: 5px; font-weight: bold; color: #fff; cursor: default; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .bg-vencido { background: #dc3545; }
    .bg-proximo { background: #ffc107; color: #000; }
    .bg-activo { background: #28a745; }
    
    .save-btn{background:#007bff;color:#fff;border:none;padding:10px 20px;cursor:pointer; border-radius: 4px; font-weight:bold;}
    .edit-btn { background:#ffc107; color:#000; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size: 17px; margin-right: 8px; width: 40px; height: 38px; }
    .delete-btn { background:#dc3545; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size: 17px; width: 40px; height: 38px; }
    .renew-btn { background:#ED9785; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size: 17px; width: 40px; height: 38px; margin-left: 5px; }
    
    .reset-btn{background:#6c757d; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:10px;}
    .search-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #007bff; border-radius: 8px; box-sizing: border-box;}

    .input-locked { border: none; background: transparent; text-align: center; width: 100%; cursor: default; pointer-events: none; font-weight: bold; }
    .input-editable { border: 1px solid #007bff !important; background: #fff !important; cursor: text !important; pointer-events: auto !important; }
    
    .celda-perfil { position: relative; transition: 0.3s; color: #000 !important; font-weight: bold; min-width: 85px; height: 50px; cursor: crosshair; }
    
    
    .p-verde {
    background-color: #28a745 !important;
    color: #000 !important;              /* TEXTO NEGRO */
    font-size: 15px;                     /* UN POCO M√ÅS GRANDE */
    font-weight: normal;
}

.p-amarillo {
    background-color: #ffc107 !important;
    color: #000 !important;              /* TEXTO NEGRO */
    font-size: 15px;
    font-weight: normal;
}

.p-rojo {
    background-color: #dc3545 !important;
    color: #fff !important;              /* TEXTO BLANCO */
    font-size: 15px;
    font-weight: normal;
}

.p-libre {
    background-color: #f8f9fa !important;
    color: #000 !important;
    font-size: 15px;
    font-weight: normal;
}

    #tooltip-flotante {
        position: fixed;
        display: none;
        background: #1e1e2f;
        color: #fff;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 9999;
        pointer-events: none;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        border: 1px solid #3d3d5c;
        line-height: 1.5;
    }
    .btn-ws-table { text-decoration: none; font-size: 16px; margin-left: 8px; vertical-align: middle; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div id=&quot;tooltip-flotante&quot;&gt;&lt;/div&gt;

&lt;div id=&quot;login&quot;&gt;
    &lt;div style=&quot;padding:100px; text-align:center;&quot;&gt;
        &lt;h2&gt;üîê Acceso al Sistema&lt;/h2&gt;
        &lt;input id=&quot;email&quot; type=&quot;email&quot; placeholder=&quot;Correo&quot;&gt;&lt;br&gt;
        &lt;input id=&quot;password&quot; type=&quot;password&quot; placeholder=&quot;Contrase√±a&quot;&gt;&lt;br&gt;
        &lt;button class=&quot;save-btn&quot; onclick=&quot;loginUser()&quot;&gt;Entrar al Panel&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;panel&quot;&gt;
    &lt;div class=&quot;sidebar&quot;&gt;
        &lt;h2 onclick=&quot;location.reload();&quot; 
        style=&quot;cursor: pointer; user-select: none; transition: 0.3s;&quot; 
        onmouseover=&quot;this.style.color='#25d366'&quot; 
        onmouseout=&quot;this.style.color=''&quot;
        title=&quot;Click para reiniciar todo el panel&quot;&gt;
        üöÄ Mi Panel
    &lt;/h2&gt;
        &lt;button onclick=&quot;mostrar('clientes')&quot;&gt;üë§ Gesti√≥n Clientes&lt;/button&gt;
        &lt;button onclick=&quot;mostrar('cuentas')&quot;&gt;üîë Asignar Cuentas&lt;/button&gt;
        &lt;button onclick=&quot;mostrar('seccionVentas')&quot;&gt;üí∞ Ventas (Historial)&lt;/button&gt;
        &lt;button onclick=&quot;mostrar('seccionVencimientos')&quot;&gt;üìÖ Vencimientos&lt;/button&gt;
        &lt;button onclick=&quot;mostrar('adminCuentas')&quot;&gt;‚öôÔ∏è Admin. Perfiles&lt;/button&gt;
        &lt;button onclick=&quot;logout()&quot;&gt;üö™ Cerrar sesi√≥n&lt;/button&gt;
    &lt;/div&gt;

    &lt;div class=&quot;content&quot;&gt;

&lt;div id=&quot;clientes&quot;&gt;
    &lt;h3&gt;üë§ Gesti√≥n de Clientes&lt;/h3&gt;
    &lt;div class=&quot;section&quot;&gt;
        &lt;h4 id=&quot;formTitle&quot;&gt;‚ú® Registrar Nuevo Cliente&lt;/h4&gt;
        &lt;input id=&quot;c_id_hidden&quot; type=&quot;hidden&quot;&gt;
        &lt;input id=&quot;c_nombre&quot; placeholder=&quot;Nombre Completo&quot; style=&quot;width: 250px;&quot;&gt;
        &lt;select id=&quot;c_codigo&quot;&gt;
            &lt;option value=&quot;+57&quot;&gt;+57&lt;/option&gt;&lt;option value=&quot;+58&quot;&gt;+58&lt;/option&gt;&lt;option value=&quot;+52&quot;&gt;+52&lt;/option&gt;&lt;option value=&quot;+1&quot;&gt;+1&lt;/option&gt;&lt;option value=&quot;+34&quot;&gt;+34&lt;/option&gt;
        &lt;/select&gt;
        &lt;input id=&quot;c_whatsapp&quot; placeholder=&quot;WhatsApp&quot;&gt;
        &lt;button class=&quot;save-btn&quot; id=&quot;btnGuardar&quot; onclick=&quot;guardarCliente()&quot;&gt;Guardar Cliente&lt;/button&gt;
        &lt;button class=&quot;save-btn&quot; id=&quot;btnCancel&quot; style=&quot;display:none; background:#6c757d;&quot; onclick=&quot;cancelarEdicion()&quot;&gt;Cancelar&lt;/button&gt;
    &lt;/div&gt;
    &lt;div class=&quot;section&quot;&gt;
        &lt;input type=&quot;text&quot; id=&quot;filtroCliente&quot; class=&quot;search-input&quot; placeholder=&quot;üîç Filtrar por nombre o servicio...&quot; onkeyup=&quot;filtrarTablaClientes()&quot;&gt;
        &lt;table id=&quot;tablaMaestraClientes&quot;&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th class=&quot;sortable&quot; onclick=&quot;ordenarTabla('nombre')&quot;&gt;Nombre Cliente ‚Üë‚Üì&lt;/th&gt;
                    &lt;th&gt;WhatsApp&lt;/th&gt;
                    &lt;th class=&quot;sortable&quot; onclick=&quot;ordenarTabla('servicios')&quot;&gt;Servicios ‚Üë‚Üì&lt;/th&gt;
                    &lt;th&gt;Acciones&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody id=&quot;bodyClientes&quot;&gt;&lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;cuentas&quot; style=&quot;display:none&quot;&gt;
    &lt;h3&gt;üîë Asignar Nueva Suscripci√≥n&lt;/h3&gt;
    &lt;div class=&quot;section&quot;&gt;
        &lt;div style=&quot;display: grid; grid-template-columns: 1fr 1fr; gap: 20px;&quot;&gt;
            &lt;div style=&quot;position: relative; width: 100%;&quot;&gt;
                &lt;label&gt;&lt;b&gt;1. Buscar Cliente (Nombre o Tel√©fono):&lt;/b&gt;&lt;/label&gt;&lt;br&gt;
                &lt;input type=&quot;text&quot; id=&quot;inputBuscarCliente&quot; autocomplete=&quot;off&quot; style=&quot;width:100%&quot; placeholder=&quot;Escribe nombre o n√∫mero...&quot; onclick=&quot;buscarClienteHibrido()&quot; onkeyup=&quot;buscarClienteHibrido()&quot;&gt;
                &lt;div id=&quot;listaSugerencias&quot; style=&quot;position: absolute; background: white; border: 1px solid #ccc; width: 100%; z-index: 2000; max-height: 250px; overflow-y: auto; display: none;&quot;&gt;&lt;/div&gt;
                &lt;input type=&quot;hidden&quot; id=&quot;clienteIdSeleccionado&quot;&gt;
                &lt;p id=&quot;txtElegido&quot; style=&quot;font-size:15px; color:green; font-weight:bold;&quot;&gt;&lt;/p&gt;
            &lt;/div&gt;
            &lt;div&gt;
                &lt;label&gt;&lt;b&gt;2. Tipo de Compra:&lt;/b&gt;&lt;/label&gt;&lt;br&gt;
                &lt;select id=&quot;tipoCompra&quot; style=&quot;width:100%&quot; onchange=&quot;cambiarModoCompra()&quot;&gt;
                    &lt;option value=&quot;individual&quot;&gt;Individual&lt;/option&gt;
                    &lt;option value=&quot;combo&quot;&gt;Combo / Lote Multiperfil&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div style=&quot;display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;&quot;&gt;
            &lt;div&gt;&lt;label&gt;Fecha Inicio:&lt;/label&gt;&lt;input type=&quot;date&quot; id=&quot;fechaInicio&quot; style=&quot;width:90%&quot; onchange=&quot;calcularFechaFin()&quot;&gt;&lt;/div&gt;
            &lt;div&gt;&lt;label&gt;D√≠as:&lt;/label&gt;&lt;select id=&quot;dias&quot; style=&quot;width:90%&quot; onchange=&quot;calcularFechaFin()&quot;&gt;&lt;option value=&quot;30&quot;&gt;30 D√≠as&lt;/option&gt;&lt;option value=&quot;60&quot;&gt;60 D√≠as&lt;/option&gt;&lt;option value=&quot;90&quot;&gt;90 D√≠as&lt;/option&gt;&lt;/select&gt;&lt;/div&gt;
            &lt;div&gt;&lt;label&gt;Vence:&lt;/label&gt;&lt;input type=&quot;date&quot; id=&quot;fechaFin&quot; style=&quot;width:90%&quot; readonly&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div style=&quot;display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;&quot;&gt;
            &lt;div&gt;&lt;label&gt;M√©todo de Pago:&lt;/label&gt;&lt;select id=&quot;metodoPago&quot; style=&quot;width:100%&quot;&gt;&lt;option value=&quot;Transferencia&quot;&gt;Transferencia&lt;/option&gt;&lt;option value=&quot;Efectivo&quot;&gt;Efectivo&lt;/option&gt;&lt;option value=&quot;Pago M√≥vil&quot;&gt;Pago M√≥vil&lt;/option&gt;&lt;/select&gt;&lt;/div&gt;
            &lt;div&gt;&lt;label&gt;Valor Total:&lt;/label&gt;&lt;input type=&quot;number&quot; id=&quot;valorPago&quot; style=&quot;width:90%&quot; placeholder=&quot;$ 0.00&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;hr&gt;
        &lt;div id=&quot;plataformas&quot;&gt;&lt;/div&gt;
        &lt;button id=&quot;btnMasPlat&quot; class=&quot;save-btn&quot; style=&quot;background:#28a745; display:none;&quot; onclick=&quot;agregarPlataforma()&quot;&gt;‚ûï Otra Plataforma/Perfil&lt;/button&gt;&lt;br&gt;&lt;br&gt;
        &lt;button class=&quot;save-btn&quot; style=&quot;width:100%; padding:15px;&quot; onclick=&quot;guardarCuentas()&quot;&gt;Finalizar y Guardar Venta&lt;/button&gt;
        &lt;button class=&quot;reset-btn&quot; style=&quot;width:100%;&quot; onclick=&quot;confirmarReinicioForm()&quot;&gt;üßπ Reiniciar Formulario&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;seccionVentas&quot; style=&quot;display:none&quot;&gt;
    &lt;h3&gt;üí∞ Historial Global de Ventas&lt;/h3&gt;
    &lt;div class=&quot;section&quot;&gt;
        &lt;input type=&quot;text&quot; id=&quot;busquedaHistorial&quot; class=&quot;search-input&quot; placeholder=&quot;üîç Buscar por nombre...&quot; onkeyup=&quot;filtrarHistorialVentas()&quot;&gt;
        &lt;table id=&quot;tablaVentasGlobal&quot;&gt;
            &lt;thead style=&quot;background: #1e1e2f; color: white;&quot;&gt;
                &lt;tr&gt;
                    &lt;th style=&quot;min-width: 120px;&quot;&gt;Registro (Fecha/Hora)&lt;/th&gt;
                    &lt;th&gt;Cliente&lt;/th&gt;
                    &lt;th&gt;Producto&lt;/th&gt;
                    &lt;th&gt;Pago&lt;/th&gt;
                    &lt;th&gt;Acceso Detallado&lt;/th&gt;
                    &lt;th&gt;Vence&lt;/th&gt;
                    &lt;th&gt;D√≠as&lt;/th&gt;
                    &lt;th&gt;Acci√≥n&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody id=&quot;bodyVentasHistorial&quot;&gt;&lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;seccionVencimientos&quot; style=&quot;display:none&quot;&gt;
    &lt;h3&gt;üìÖ Control de Vencimientos&lt;/h3&gt;
    &lt;div class=&quot;section&quot; style=&quot;border-left:8px solid #ffc107&quot;&gt;
        &lt;h4&gt;‚ö†Ô∏è Pr√≥ximas (0-5 d√≠as)&lt;/h4&gt;
        &lt;table id=&quot;tablaProximas&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Cliente&lt;/th&gt;&lt;th&gt;Servicio(s)&lt;/th&gt;&lt;th&gt;Fechas&lt;/th&gt;&lt;th&gt;Acceso Detallado&lt;/th&gt;&lt;th&gt;Estado&lt;/th&gt;&lt;th&gt;Renovaci√≥n&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody id=&quot;bodyProximas&quot;&gt;&lt;/tbody&gt;&lt;/table&gt;
    &lt;/div&gt;
    &lt;div class=&quot;section&quot; style=&quot;border-left:8px solid #dc3545&quot;&gt;
        &lt;h4&gt;‚ùå Vencidas&lt;/h4&gt;
        &lt;table id=&quot;tablaVencidas&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Cliente&lt;/th&gt;&lt;th&gt;Servicio(s)&lt;/th&gt;&lt;th&gt;Fechas&lt;/th&gt;&lt;th&gt;Acceso Detallado&lt;/th&gt;&lt;th&gt;Estado&lt;/th&gt;&lt;th&gt;Renovaci√≥n&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody id=&quot;bodyVencidas&quot;&gt;&lt;/tbody&gt;&lt;/table&gt;
    &lt;/div&gt;
    &lt;div class=&quot;section&quot; style=&quot;border-left:8px solid #28a745&quot;&gt;
        &lt;h4&gt;‚úÖ Vigentes&lt;/h4&gt;
        &lt;table id=&quot;tablaVigentes&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Cliente&lt;/th&gt;&lt;th&gt;Servicio(s)&lt;/th&gt;&lt;th&gt;Fechas&lt;/th&gt;&lt;th&gt;Acceso Detallado&lt;/th&gt;&lt;th&gt;Estado&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody id=&quot;bodyVigentes&quot;&gt;&lt;/tbody&gt;&lt;/table&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;adminCuentas&quot; style=&quot;display:none&quot;&gt;
    &lt;h3&gt;‚öôÔ∏è Administrador de Perfiles Base&lt;/h3&gt;
    
    &lt;div class=&quot;section&quot; style=&quot;border-top: 5px solid #e50914;&quot;&gt;
        &lt;h4&gt;üì∫ Netflix (5 Perfiles)&lt;/h4&gt;
        &lt;div style=&quot;overflow-x: auto;&quot;&gt;
            &lt;table&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;Correo&lt;/th&gt;&lt;th&gt;Contrase√±a&lt;/th&gt;
                        &lt;th&gt;P1&lt;/th&gt;&lt;th&gt;P2&lt;/th&gt;&lt;th&gt;P3&lt;/th&gt;&lt;th&gt;P4&lt;/th&gt;&lt;th&gt;P5&lt;/th&gt;
                        &lt;th style=&quot;width: 130px;&quot;&gt;Modificado&lt;/th&gt;&lt;th&gt;Acci√≥n&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody id=&quot;tablaNetflixBody&quot;&gt;&lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
        &lt;button class=&quot;save-btn&quot; style=&quot;background:#e50914;&quot; onclick=&quot;abrirModalNuevaCuenta('Netflix')&quot;&gt;‚ûï A√±adir Cuenta Netflix&lt;/button&gt;
    &lt;/div&gt;

    &lt;div class=&quot;section&quot; style=&quot;border-top: 5px solid #006e99;&quot;&gt;
        &lt;h4&gt;üé¨ Disney (7 Perfiles)&lt;/h4&gt;
        &lt;div style=&quot;overflow-x: auto;&quot;&gt;
            &lt;table&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;Correo&lt;/th&gt;&lt;th&gt;Contrase√±a&lt;/th&gt;
                        &lt;th&gt;P1&lt;/th&gt;&lt;th&gt;P2&lt;/th&gt;&lt;th&gt;P3&lt;/th&gt;&lt;th&gt;P4&lt;/th&gt;&lt;th&gt;P5&lt;/th&gt;&lt;th&gt;P6&lt;/th&gt;&lt;th&gt;P7&lt;/th&gt;
                        &lt;th style=&quot;width: 130px;&quot;&gt;Modificado&lt;/th&gt;&lt;th&gt;Acci√≥n&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody id=&quot;tablaDisneyBody&quot;&gt;&lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
        &lt;button class=&quot;save-btn&quot; style=&quot;background:#006e99;&quot; onclick=&quot;abrirModalNuevaCuenta('Disney')&quot;&gt;‚ûï A√±adir Disney&lt;/button&gt;
    &lt;/div&gt;

    &lt;div class=&quot;section&quot; style=&quot;border-top: 5px solid #5822b4;&quot;&gt;
        &lt;h4&gt;üíú HBO Max (5 Perfiles)&lt;/h4&gt;
        &lt;div style=&quot;overflow-x: auto;&quot;&gt;
           &lt;table border=&quot;1&quot;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Correo&lt;/th&gt;
            &lt;th&gt;Clave&lt;/th&gt;
            &lt;th colspan=&quot;5&quot;&gt;Perfiles (HBO)&lt;/th&gt; &lt;th&gt;Modificado&lt;/th&gt;
            &lt;th&gt;Acci√≥n&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody id=&quot;tablaHBOBody&quot;&gt;&lt;/tbody&gt;
&lt;/table&gt;
            &lt;/table&gt;
        &lt;/div&gt;
        &lt;button class=&quot;save-btn&quot; style=&quot;background:#5822b4;&quot; onclick=&quot;abrirModalNuevaCuenta('HBO')&quot;&gt;‚ûï A√±adir HBO&lt;/button&gt;
    &lt;/div&gt;
    
    &lt;!-- SECCI√ìN ADMINISTRADOR: OTROS SERVICIOS --&gt;
&lt;div class=&quot;section&quot; style=&quot;border-top: 5px solid #25d366;&quot;&gt;
    &lt;h4&gt;üåê Otros Servicios (6 Perfiles)&lt;/h4&gt;
    &lt;div style=&quot;overflow-x: auto;&quot;&gt;
        &lt;table&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;Plataforma&lt;/th&gt;
                    &lt;th&gt;Cuenta (Usuario / URL)&lt;/th&gt;
                    &lt;th&gt;Clave&lt;/th&gt;
                    &lt;th&gt;P1&lt;/th&gt;&lt;th&gt;P2&lt;/th&gt;&lt;th&gt;P3&lt;/th&gt;&lt;th&gt;P4&lt;/th&gt;&lt;th&gt;P5&lt;/th&gt;&lt;th&gt;P6&lt;/th&gt;
                    &lt;th&gt;Acci√≥n&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody id=&quot;tablaOtrosBody&quot;&gt;&lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
    &lt;button class=&quot;save-btn&quot; style=&quot;background:#25d366;&quot; onclick=&quot;mostrarModalNuevoServicio()&quot;&gt;‚ûï A√±adir Nuevo Servicio&lt;/button&gt;
&lt;/div&gt;

&lt;!-- MODAL PARA AGREGAR CUENTAS --&gt;
&lt;div id=&quot;modalNuevoServicio&quot; style=&quot;display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a1a; padding:20px; border:2px solid #25d366; z-index:1000; border-radius:10px; color:white; width:320px;&quot;&gt;
    &lt;h3&gt;Nueva Cuenta Base&lt;/h3&gt;
    &lt;label&gt;Plataforma:&lt;/label&gt;&lt;br&gt;
    &lt;select id=&quot;selPlataformaOtros&quot; onchange=&quot;chequearIPTV(this.value)&quot; style=&quot;width:100%; padding:8px; margin:10px 0; background:#333; color:white;&quot;&gt;
        &lt;option value=&quot;Prime Video&quot;&gt;Prime Video&lt;/option&gt;
        &lt;option value=&quot;IPTV&quot;&gt;IPTV&lt;/option&gt;
        &lt;option value=&quot;Crunchyroll&quot;&gt;Crunchyroll&lt;/option&gt;
        &lt;option value=&quot;Disney+&quot;&gt;Disney+&lt;/option&gt;
        &lt;option value=&quot;Paramount+&quot;&gt;Paramount+&lt;/option&gt;
    &lt;/select&gt;&lt;br&gt;

    &lt;div id=&quot;divUrlIptv&quot; style=&quot;display:none;&quot;&gt;
        &lt;label&gt;URL del Servidor:&lt;/label&gt;
        &lt;input type=&quot;text&quot; id=&quot;inpUrlIptv&quot; placeholder=&quot;http://servidor.com:8080&quot; style=&quot;width:90%; padding:8px; margin-bottom:10px;&quot;&gt;
    &lt;/div&gt;

    &lt;input type=&quot;text&quot; id=&quot;inpCorreoOtros&quot; placeholder=&quot;Usuario o Correo&quot; style=&quot;width:90%; padding:8px; margin-bottom:10px;&quot;&gt;
    &lt;input type=&quot;text&quot; id=&quot;inpClaveOtros&quot; placeholder=&quot;Contrase√±a&quot; style=&quot;width:90%; padding:8px; margin-bottom:15px;&quot;&gt;

    &lt;div style=&quot;display:flex; gap:10px;&quot;&gt;
        &lt;button onclick=&quot;guardarServicioManual()&quot; style=&quot;background:#25d366; color:white; border:none; padding:10px; flex:1; cursor:pointer;&quot;&gt;GUARDAR&lt;/button&gt;
        &lt;button onclick=&quot;cerrarModalOtros()&quot; style=&quot;background:#555; color:white; border:none; padding:10px; flex:1; cursor:pointer;&quot;&gt;CANCELAR&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

    &lt;/div&gt;
    
    
&lt;/div&gt;

&lt;script&gt;
const firebaseConfig={ apiKey:&quot;AIzaSyBZKmJQ7TcszQeBu--3jK4sxA3F3tAF_N8&quot;, authDomain:&quot;panel-cuentas-clientes.firebaseapp.com&quot;, projectId:&quot;panel-cuentas-clientes&quot; };
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore(); const auth=firebase.auth();

let clienteActualId = null; // ‚Üê ID del cliente que se est√° editando
let ventaActualId = null;   // ‚Üê ID del registro/venta (MUY IMPORTANTE)
let listaSuscripcionesGlobal = [];
let listaClientesLocal = [];
let idFilaSeleccionadaAzul = null; 
let idModificando = null; 
let vencimientoOriginalParaEdicion = &quot;&quot;; 
let fechaFinalCalculadaGarantia = &quot;&quot;;
const hoy = new Date(); hoy.setHours(0,0,0,0);
function formatearDiasTexto(diff) {
    if (diff &gt; 2) return &quot;Vence en &quot; + Math.abs(diff) + &quot;d&quot;;
    if (diff === 0) return &quot;Vence Hoy&quot;;
    if (diff === 1) return &quot;Vence Ma√±ana&quot;;
    if (diff === -1) return &quot;Venci√≥ Ayer&quot;;
    if (diff &lt; -1) return &quot;Venci√≥ hace &quot; + Math.abs(diff) + &quot;d&quot;;
    return diff + &quot;d&quot;;
}
const tooltip = document.getElementById('tooltip-flotante');

auth.onAuthStateChanged(u=&gt;{
    if(u){ 
        login.style.display=&quot;none&quot;; panel.style.display=&quot;block&quot;; 
        const ahora = new Date(); const offset = ahora.getTimezoneOffset() * 60000;
        fechaInicio.value = (new Date(ahora - offset)).toISOString().split(&quot;T&quot;)[0];
        actualizarTodo();
    }
    else{ login.style.display=&quot;block&quot;; panel.style.display=&quot;none&quot;; }
});

async function actualizarTodo() {
    const snap = await db.collection(&quot;cuentas&quot;).get();
    listaSuscripcionesGlobal = [];
    snap.forEach(doc =&gt; { listaSuscripcionesGlobal.push({id: doc.id, ...doc.data()}); });
    cargarClientes(); 
    cargarAdminPerfiles();
}
function chequearIPTV(val) {
    document.getElementById(&quot;divUrlIptv&quot;).style.display = (val === &quot;IPTV&quot;) ? &quot;block&quot; : &quot;none&quot;;
}

function mostrarModalNuevoServicio() {
    document.getElementById(&quot;modalNuevoServicio&quot;).style.display = &quot;block&quot;;
}

function cerrarModalOtros() {
    document.getElementById(&quot;modalNuevoServicio&quot;).style.display = &quot;none&quot;;
}

async function guardarServicioManual() {
    const plat = document.getElementById(&quot;selPlataformaOtros&quot;).value;
    let corr = document.getElementById(&quot;inpCorreoOtros&quot;).value.trim();
    const clav = document.getElementById(&quot;inpClaveOtros&quot;).value.trim();
    const urlIptv = document.getElementById(&quot;inpUrlIptv&quot;).value.trim();

    if(!corr || !clav) return alert(&quot;Llena los campos obligatorios&quot;);

    // FUSI√ìN PARA IPTV
    if (plat === &quot;IPTV&quot; &amp;&amp; urlIptv !== &quot;&quot;) {
        corr = `${corr} / ${urlIptv}`;
    }

    try {
        await db.collection(&quot;cuentas_base&quot;).add({
            plataforma: plat,
            correo: corr,
            clave: clav,
            ultimaModificacion: new Date().toISOString()
        });
        alert(&quot;‚úÖ Guardado: &quot; + corr);
        cerrarModalOtros();
        cargarCuentasBase();
    } catch (e) {
        alert(&quot;Error: &quot; + e.message);
    }
}

async function cargarCuentasBase() {
    const tablas = [&quot;tablaNetflixBody&quot;, &quot;tablaDisneyBody&quot;, &quot;tablaHBOBody&quot;, &quot;tablaOtrosBody&quot;];
    tablas.forEach(id =&gt; { if(document.getElementById(id)) document.getElementById(id).innerHTML = &quot;&quot;; });

    try {
        const snap = await db.collection(&quot;cuentas_base&quot;).get();
        const ventas = (typeof listaSuscripcionesGlobal !== 'undefined') ? listaSuscripcionesGlobal : [];

        snap.forEach(doc =&gt; {
            const d = doc.data();
            const id = doc.id; // LLAVE √öNICA DE LA CUENTA

            if (d.plataforma !== &quot;Netflix&quot; &amp;&amp; d.plataforma !== &quot;Disney&quot; &amp;&amp; d.plataforma !== &quot;HBO&quot;) {
                const tr = document.createElement(&quot;tr&quot;);
                let perfilesHTML = &quot;&quot;;

                // Dibujar los 6 perfiles
                for (let i = 1; i &lt;= 6; i++) {
                    const ocupado = ventas.some(v =&gt; v.correo === d.correo &amp;&amp; v.plataforma === d.plataforma &amp;&amp; v.perfil == i);
                    perfilesHTML += `&lt;td&gt;&lt;div class=&quot;perfil-circulo ${ocupado ? 'ocupado' : 'libre'}&quot;&gt;${i}&lt;/div&gt;&lt;/td&gt;`;
                }

                // AQU√ç SE GENERA EL BOT√ìN - REVISA QUE EST√â IGUAL
                tr.innerHTML = `
                    &lt;td&gt;&lt;b&gt;${d.plataforma}&lt;/b&gt;&lt;/td&gt;
                    &lt;td style=&quot;font-size:11px;&quot;&gt;${d.correo}&lt;/td&gt;
                    &lt;td&gt;${d.clave}&lt;/td&gt;
                    ${perfilesHTML}
                    &lt;td&gt;
                        &lt;button class=&quot;edit-btn&quot;
onclick=&quot;abrirModalEditarCuenta('${id}', '${d.correo}', '${d.clave}')&quot;&gt;‚úèÔ∏è&lt;/button&gt;

                        &lt;button onclick=&quot;eliminarCuentaBase('${id}')&quot; style=&quot;background:none; border:none; cursor:pointer; font-size:18px;&quot; title=&quot;Eliminar&quot;&gt;üóëÔ∏è&lt;/button&gt;
                    &lt;/td&gt;
                `;
                document.getElementById(&quot;tablaOtrosBody&quot;).appendChild(tr);
            }
        });
    } catch (err) {
        console.error(&quot;Error cargando cuentas: &quot;, err);
    }
}
function mostrarSeccion(idSeccion) {
    // 1. Ocultar todas las secciones primero
    const secciones = document.querySelectorAll(&quot;.seccion-pantalla&quot;);
    secciones.forEach(s =&gt; s.style.display = &quot;none&quot;);

    // 2. Mostrar la seccion solicitada
    const seccionActiva = document.getElementById(idSeccion);
    if (seccionActiva) {
        seccionActiva.style.display = &quot;block&quot;;
        
        // 3. ¬°ESTO ES LO QUE BUSCAS! 
        // Si la secci√≥n que se abre es la de perfiles (ajusta el ID si es distinto)
        if (idSeccion === &quot;seccionAdministrador&quot;) {
            console.log(&quot;Abriendo administrador: Cargando servicios...&quot;);
            cargarCuentasBase(); 
        }
    }
}

function cargarVentasVencimientos(){
    bodyVencidas.innerHTML = &quot;&quot;; bodyProximas.innerHTML = &quot;&quot;; bodyVigentes.innerHTML = &quot;&quot;;
    document.getElementById(&quot;bodyVentasHistorial&quot;).innerHTML = &quot;&quot;;
    const gruposVencimiento = {};
    const gruposHistorial = {}; 

    listaSuscripcionesGlobal.forEach(d =&gt; {
        const batchKey = `${d.clienteId}_${d.fechaRegistro || 0}`;
        if (!gruposVencimiento[batchKey]) {
            gruposVencimiento[batchKey] = { 
                ...d, 
                serviciosTexto: [d.plataforma],
                detalles: [`&lt;b&gt;${d.plataforma}&lt;/b&gt;: ${d.correo} (P:${d.perfil_etiqueta} PIN:${d.pin})`],
                ids: [d.id],
                dataRenew: [{ plat: d.plataforma, correo: d.correo, clave: d.clave, perfil: d.perfil, pin: d.pin }]
            };
        } else {
            gruposVencimiento[batchKey].serviciosTexto.push(d.plataforma);
            gruposVencimiento[batchKey].detalles.push(`&lt;b&gt;${d.plataforma}&lt;/b&gt;: ${d.correo} (P:${d.perfil_etiqueta} PIN:${d.pin})`);
            gruposVencimiento[batchKey].ids.push(d.id);
            gruposVencimiento[batchKey].dataRenew.push({ plat: d.plataforma, correo: d.correo, clave: d.clave, perfil: d.perfil, pin: d.pin });
        }

        const historialKey = `${d.clienteId}_${d.fechaRegistro}`;
        if (!gruposHistorial[historialKey]) {
            gruposHistorial[historialKey] = {
                ...d,
                plataformasCojuntas: [d.plataforma],
                valorTotal: parseFloat(d.valor || 0),
                detallesFull: [`&lt;div style=&quot;margin-bottom:8px;&quot;&gt;&lt;b&gt;üì∫ ${d.plataforma}&lt;/b&gt;&lt;br&gt;üìß ${d.correo}&lt;br&gt;üîë ${d.clave}&lt;br&gt;üë§ Perfil: ${d.perfil} | üìå PIN: ${d.pin}&lt;/div&gt;`],
                idsParaEliminar: [d.id] 
            };
        } else {
            gruposHistorial[historialKey].plataformasCojuntas.push(d.plataforma);
            gruposHistorial[historialKey].valorTotal += parseFloat(d.valor || 0);
            gruposHistorial[historialKey].detallesFull.push(`&lt;div style=&quot;margin-bottom:8px;&quot;&gt;&lt;b&gt;üì∫ ${d.plataforma}&lt;/b&gt;&lt;br&gt;üìß ${d.correo}&lt;br&gt;üîë ${d.clave}&lt;br&gt;üë§ Perfil: ${d.perfil} | üìå PIN: ${d.pin}&lt;/div&gt;`);
            gruposHistorial[historialKey].idsParaEliminar.push(d.id);
        }
    });

    Object.values(gruposVencimiento).sort((a,b) =&gt; (b.fechaRegistro || 0) - (a.fechaRegistro || 0)).forEach(g =&gt; {
    // --- L√ìGICA DE D√çAS (MES COMERCIAL 30D) ---
    const partesFin = g.fin.split('-');
    const fechaVenceObj = new Date(partesFin[0], partesFin[1] - 1, partesFin[2]);
    fechaVenceObj.setHours(0, 0, 0, 0);

    const hoyLocal = new Date();
    hoyLocal.setHours(0, 0, 0, 0);

    // C√°lculo real
    let diff = Math.round((fechaVenceObj - hoyLocal) / 86400000);

    // AJUSTE PARA FEBRERO/MESES CORTOS: 
    // Si se compr√≥ hoy y la fecha de fin es el pr√≥ximo mes, forzamos 30d
    const partesInicio = g.inicio.split('-');
    const fechaInicioObj = new Date(partesInicio[0], partesInicio[1] - 1, partesInicio[2]);
    fechaInicioObj.setHours(0,0,0,0);

    if (fechaInicioObj.getTime() === hoyLocal.getTime() &amp;&amp; diff &gt; 0 &amp;&amp; diff &lt; 31) {
        diff = 30; 
    }

    const clienteObj = listaClientesLocal.find(c =&gt; c.id === g.clienteId);
    const nomC = clienteObj?.nombre || &quot;---&quot;;
    const telC = clienteObj?.whatsapp || &quot;&quot;;

    let colorClase = diff &lt; 0 ? &quot;status-vencido&quot; : (diff &lt;= 5 ? &quot;status-proximo&quot; : &quot;status-activo&quot;);
    let rowId = `fila-${g.clienteId}-${g.fechaRegistro}`;
    let clasePersistente = (g.marcado_renovado === true) ? &quot;row-finalizada-color&quot; : &quot;&quot;;
    let claseAzul = (idFilaSeleccionadaAzul === rowId) ? &quot;row-selected-renew&quot; : &quot;&quot;;

    // --- L√ìGICA DE COMUNICACI√ìN (WHATSAPP) ---
    const ahoraMomento = new Date();
    const diasSemana = [&quot;domingo&quot;, &quot;lunes&quot;, &quot;martes&quot;, &quot;miercoles&quot;, &quot;jueves&quot;, &quot;viernes&quot;, &quot;sabado&quot;];
    const diaNombreVence = diasSemana[fechaVenceObj.getDay()];
    const fechaVenceFormato = g.fin.split('-').reverse().join('-'); 
    const horaActual = ahoraMomento.getHours().toString().padStart(2, '0') + &quot;:&quot; + ahoraMomento.getMinutes().toString().padStart(2, '0');

    let btnWhatsapp = &quot;&quot;;
    let btnRenovar = &quot;&quot;;

    if (diff &lt;= 5) {
        let textoEstado = &quot;&quot;;
        let palabraFinaliza = &quot;finaliza&quot;;
        const serviciosChat = g.serviciosTexto.join(&quot; + &quot;);

        if (diff &lt; 0) {
            palabraFinaliza = &quot;Finalizo&quot;;
            const dAbs = Math.abs(diff);
            textoEstado = &quot;*Ya vencio hace &quot; + dAbs + &quot; &quot; + (dAbs === 1 ? &quot;dia&quot; : &quot;dias&quot;) + &quot;*&quot;;
        } else {
            textoEstado = &quot;*&quot; + (diff === 0 ? &quot;vence hoy mismo&quot; : (diff === 1 ? &quot;vence ma√±ana&quot; : &quot;vence en &quot; + diff + &quot; dias&quot;)) + &quot;*&quot;;
        }

        let cuerpoTxt = &quot;Hola *_&quot; + nomC + &quot;_* (Ã∂‚óâÕõ‚Äø‚óâÃ∂), C√≥mo estas?.\n\n&quot; +
            &quot;Para informarte que tu Servicio de *&quot; + serviciosChat + &quot;*  &quot; + textoEstado + &quot;\n&quot; +
            &quot;ÏõÉ El d√≠a *&quot; + diaNombreVence + &quot;* *&quot; + fechaVenceFormato + &quot;* &quot; + palabraFinaliza + &quot; el servicio. \n\n&quot; +
            &quot;‚úç(‚óî‚ó°‚óî)   Porfa confirma si deseas renovar nuevamente el servicio con nosotros --\n&quot; +
            &quot;Quedamos muy atentos a tu mensaje de respuesta.\n\n&quot; +
            &quot;Mensaje enviado el dia *&quot; + diasSemana[ahoraMomento.getDay()] + &quot;*, *&quot; + ahoraMomento.toLocaleDateString() + &quot;* a las *&quot; + horaActual + &quot;*.\n&quot; +
            &quot;*Somos MultiEntretenimiento BC  ï‚Ä¢ÃÅ·¥•‚Ä¢ÃÄ î„Å£, El mejor entretenimiento para todos*&quot;;

        let soloNumeros = telC.replace(/\D/g, ''); 
        if (soloNumeros) {
            btnWhatsapp = `&lt;a href=&quot;https://wa.me/${soloNumeros}?text=${encodeURIComponent(cuerpoTxt)}&quot; target=&quot;_blank&quot; class=&quot;btn-ws-table&quot;&gt;üü¢&lt;/a&gt;`;
        }
        btnRenovar = `&lt;button class=&quot;renew-btn&quot; onclick='cargarLoteParaRenovar(${JSON.stringify(g.clienteId)}, ${JSON.stringify(g.dataRenew)}, &quot;${rowId}&quot;, ${JSON.stringify(g.ids)})'&gt;‚úî&lt;/button&gt;`;
    }

    // --- FILA FINAL ---
    let row = `&lt;tr id=&quot;${rowId}&quot; class=&quot;${clasePersistente} ${claseAzul}&quot;&gt;
        &lt;td&gt;&lt;b&gt;${nomC}&lt;/b&gt; ${btnWhatsapp}&lt;/td&gt;
        &lt;td&gt;${g.serviciosTexto.join(&quot;, &quot;)}&lt;/td&gt;
        &lt;td&gt;&lt;small&gt;I:${g.inicio}&lt;br&gt;F:${g.fin}&lt;/small&gt;&lt;/td&gt;
        &lt;td&gt;${g.detalles.join(&quot;&lt;br&gt;&quot;)}&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;${colorClase}&quot;&gt;${formatearDiasTexto(diff)}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;${btnRenovar}&lt;/td&gt;
    &lt;/tr&gt;`;
    
    if(diff &lt; 0) bodyVencidas.innerHTML += row; else if(diff &lt;= 5) bodyProximas.innerHTML += row; else bodyVigentes.innerHTML += row;
});

    Object.values(gruposHistorial).sort((a,b)=&gt; (b.fechaRegistro||0)-(a.fechaRegistro||0)).forEach(d =&gt; {
        const nomC = listaClientesLocal.find(c =&gt; c.id === d.clienteId)?.nombre || &quot;---&quot;;
        const diff = Math.ceil((new Date(d.fin + &quot;T12:00:00&quot;) - hoy) / (1000 * 60 * 60 * 24))-1;
        let rowColorClass = diff &lt; 0 ? &quot;row-vencido&quot; : (diff &lt;= 5 ? &quot;row-proximo&quot; : &quot;row-activo&quot;);
        let fechaFull = &quot;---&quot;;
        if(d.fechaRegistro) {
            const dateObj = new Date(d.fechaRegistro);
            fechaFull = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()} &lt;br&gt; &lt;small&gt;${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}&lt;/small&gt;`;
        }
        document.getElementById(&quot;bodyVentasHistorial&quot;).innerHTML += `&lt;tr class=&quot;${rowColorClass}&quot;&gt;
    &lt;td style=&quot;font-size:15px;&quot;&gt;${fechaFull}&lt;/td&gt;
    &lt;td&gt;&lt;b&gt;${nomC}&lt;/b&gt;&lt;/td&gt;
    &lt;td&gt;${d.plataformasCojuntas.join(&quot;&lt;br&gt;&quot;)}&lt;/td&gt;
    &lt;td style=&quot;color:#28a745; font-weight:bold;&quot;&gt;$${d.valorTotal.toFixed(2)}&lt;br&gt;&lt;small style=&quot;color:gray;&quot;&gt;(${d.metodoPago || 'S/M'})&lt;/small&gt;&lt;/td&gt;
    &lt;td style=&quot;text-align:left; font-size:15px;&quot;&gt;${d.detallesFull.join(&quot;&lt;hr style='margin:5px 0; border:0; border-top:1px dashed #ccc'&gt;&quot;)}&lt;/td&gt;
    &lt;td&gt;${d.fin}&lt;/td&gt;
    &lt;td&gt;&lt;b&gt;${formatearDiasTexto(diff)}&lt;/b&gt;&lt;/td&gt;
    &lt;td&gt;
        &lt;div style=&quot;display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;&quot;&gt;
            &lt;button onclick=&quot;enviarWhatsAppLote('${d.idsParaEliminar.join(',')}')&quot; title=&quot;Enviar WhatsApp&quot; style=&quot;background:#25d366; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:16px;&quot;&gt;üì±&lt;/button&gt;
            &lt;button onclick=&quot;abrirEditorManualLote('${d.idsParaEliminar.join(',')}')&quot; title=&quot;Editar Manual&quot; style=&quot;background:#ffc107; color:black; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:16px;&quot;&gt;‚úèÔ∏è&lt;/button&gt;
            &lt;button class=&quot;delete-btn&quot; onclick=&quot;eliminarLoteHistorial('${d.idsParaEliminar.join(',')}')&quot; style=&quot;padding:6px; font-size:16px;&quot;&gt;üóëÔ∏è&lt;/button&gt;
        &lt;/div&gt;
    &lt;/td&gt;
&lt;/tr&gt;`;
    });
}

async function eliminarLoteHistorial(idsString) { if(confirm(&quot;¬øEliminar este registro de venta completo?&quot;)) { const ids = idsString.split(','); const batch = db.batch(); ids.forEach(id =&gt; batch.delete(db.collection(&quot;cuentas&quot;).doc(id))); await batch.commit(); actualizarTodo(); } }
async function marcarComoRenovadoEnBD(listaIds, rowId) { const batch = db.batch(); listaIds.forEach(id =&gt; { const ref = db.collection(&quot;cuentas&quot;).doc(id); batch.update(ref, { marcado_renovado: true }); }); await batch.commit(); const fila = document.getElementById(rowId); if(fila) fila.classList.add('row-finalizada-color'); }

function renderizarTablaClientes(){ 
    bodyClientes.innerHTML=&quot;&quot;; 
    listaClientesLocal.sort((a,b)=&gt;a.nombre.localeCompare(b.nombre)).forEach(c=&gt;{ 
        let hServ=&quot;&quot;; 
        c.servsData.forEach(ser=&gt;{ 
            const diff = Math.ceil((new Date(ser.fin+&quot;T12:00:00&quot;)-hoy)/(1000*60*60*24))-1; 
            if(diff &lt;= -5) return; 

            let cl = diff &lt; 0 ? &quot;bg-vencido&quot; : (diff &lt;= 5 ? &quot;bg-proximo&quot; : &quot;bg-activo&quot;);
            
            const infoTooltip = `
                &lt;b&gt;üì∫ ${ser.plataforma}&lt;/b&gt;&lt;br&gt;
                üìß ${ser.correo}&lt;br&gt;
                üîë ${ser.clave}&lt;br&gt;
                üë§ Perfil: ${ser.perfil}&lt;br&gt;
                üìå PIN: ${ser.pin}&lt;br&gt;
                üìÖ Inicio: ${ser.inicio}&lt;br&gt;
                üö© Fin: ${ser.fin}&lt;br&gt;
                ‚è≥ Faltan: ${diff} d√≠as
            `;

            hServ += `
                &lt;span class=&quot;badge-service ${cl}&quot; 
                      data-info='${infoTooltip}' 
                      onmousemove=&quot;mostrarTooltip(event)&quot; 
                      onmouseleave=&quot;ocultarTooltip()&quot;&gt;
                      ${ser.plataforma} (${diff}d)
                &lt;/span&gt;`; 
        }); 

        bodyClientes.innerHTML += `
            &lt;tr&gt;
                &lt;td style=&quot;text-align:left; padding-left:15px;&quot;&gt;
                    &lt;span class=&quot;service-count&quot;&gt;${c.cantServiciosActivos}&lt;/span&gt;
                    &lt;b&gt;${c.nombre}&lt;/b&gt;
                &lt;/td&gt;
                &lt;td&gt;üìû ${c.whatsapp}&lt;/td&gt;
                &lt;td&gt;${hServ}&lt;/td&gt;
                &lt;td&gt;
                    &lt;button class=&quot;edit-btn&quot; onclick=&quot;prepararEdicion('${c.id}','${c.nombre}','${c.whatsapp}')&quot;&gt;‚úèÔ∏è&lt;/button&gt;
                    &lt;button class=&quot;delete-btn&quot; onclick=&quot;eliminarCliente('${c.id}')&quot;&gt;üóëÔ∏è&lt;/button&gt;
                &lt;/td&gt;
            &lt;/tr&gt;`; 
    }); 
}

async function eliminarLoteHistorial(idsString) { if(confirm(&quot;¬øEliminar este registro de venta completo?&quot;)) { const ids = idsString.split(','); const batch = db.batch(); ids.forEach(id =&gt; batch.delete(db.collection(&quot;cuentas&quot;).doc(id))); await batch.commit(); actualizarTodo(); } }
async function marcarComoRenovadoEnBD(listaIds, rowId) { const batch = db.batch(); listaIds.forEach(id =&gt; { const ref = db.collection(&quot;cuentas&quot;).doc(id); batch.update(ref, { marcado_renovado: true }); }); await batch.commit(); const fila = document.getElementById(rowId); if(fila) fila.classList.add('row-finalizada-color'); }

function renderizarTablaClientes(){ 
    bodyClientes.innerHTML=&quot;&quot;; 
    listaClientesLocal.sort((a,b)=&gt;a.nombre.localeCompare(b.nombre)).forEach(c=&gt;{ 
        let hServ=&quot;&quot;; 
        c.servsData.forEach(ser=&gt;{ 
            const diff = Math.ceil((new Date(ser.fin+&quot;T12:00:00&quot;)-hoy)/(1000*60*60*24))-1; 
            if(diff &lt;= -5) return; 

            let cl = diff &lt; 0 ? &quot;bg-vencido&quot; : (diff &lt;= 5 ? &quot;bg-proximo&quot; : &quot;bg-activo&quot;);
            
            const infoTooltip = `
                &lt;b&gt;üì∫ ${ser.plataforma}&lt;/b&gt;&lt;br&gt;
                üìß ${ser.correo}&lt;br&gt;
                üîë ${ser.clave}&lt;br&gt;
                üë§ Perfil: ${ser.perfil}&lt;br&gt;
                üìå PIN: ${ser.pin}&lt;br&gt;
                üìÖ Inicio: ${ser.inicio}&lt;br&gt;
                üö© Fin: ${ser.fin}&lt;br&gt;
                ‚è≥ Faltan: ${diff} d√≠as
            `;

            hServ += `
                &lt;span class=&quot;badge-service ${cl}&quot; 
                      data-info='${infoTooltip}' 
                      onmousemove=&quot;mostrarTooltip(event)&quot; 
                      onmouseleave=&quot;ocultarTooltip()&quot;&gt;
                      ${ser.plataforma} (${diff}d)
                &lt;/span&gt;`; 
        }); 

        bodyClientes.innerHTML += `
            &lt;tr&gt;
                &lt;td style=&quot;text-align:left; padding-left:15px;&quot;&gt;
                    &lt;span class=&quot;service-count&quot;&gt;${c.cantServiciosActivos}&lt;/span&gt;
                    &lt;b&gt;${c.nombre}&lt;/b&gt;
                &lt;/td&gt;
                &lt;td&gt;üìû ${c.whatsapp}&lt;/td&gt;
                &lt;td&gt;${hServ}&lt;/td&gt;
                &lt;td&gt;
                    &lt;button class=&quot;edit-btn&quot; onclick=&quot;prepararEdicion('${c.id}','${c.nombre}','${c.whatsapp}')&quot;&gt;‚úèÔ∏è&lt;/button&gt;
                    &lt;button class=&quot;delete-btn&quot; onclick=&quot;eliminarCliente('${c.id}')&quot;&gt;üóëÔ∏è&lt;/button&gt;
                &lt;/td&gt;
            &lt;/tr&gt;`; 
    }); 
}



function prepararEdicion(id, nombre, whatsappFull) { formTitle.innerText = &quot;‚úèÔ∏è Editando Cliente&quot;; btnGuardar.innerText = &quot;Actualizar Cliente&quot;; btnCancel.style.display = &quot;inline-block&quot;; c_id_hidden.value = id; c_nombre.value = nombre; const partes = whatsappFull.split(&quot; &quot;); if (partes.length &gt; 1) { c_codigo.value = partes[0]; c_whatsapp.value = partes[1]; } else { c_whatsapp.value = whatsappFull; } window.scrollTo({top: 0, behavior: 'smooth'}); }
function guardarCliente(){ const id = c_id_hidden.value; const data = { nombre: c_nombre.value, whatsapp: c_codigo.value + &quot; &quot; + c_whatsapp.value }; if(!data.nombre || !c_whatsapp.value) return alert(&quot;Completa los datos&quot;); if(id) { db.collection(&quot;clientes&quot;).doc(id).update(data).then(() =&gt; { alert(&quot;Cliente actualizado&quot;); cancelarEdicion(); actualizarTodo(); }).catch(e =&gt; alert(&quot;Error: &quot; + e.message)); } else { db.collection(&quot;clientes&quot;).add(data).then(() =&gt; { c_nombre.value = &quot;&quot;; c_whatsapp.value = &quot;&quot;; actualizarTodo(); }); } }
function cancelarEdicion(){ c_id_hidden.value=&quot;&quot;; c_nombre.value=&quot;&quot;; c_whatsapp.value=&quot;&quot;; formTitle.innerText=&quot;‚ú® Registrar Nuevo Cliente&quot;; btnGuardar.innerText=&quot;Guardar Cliente&quot;; btnCancel.style.display=&quot;none&quot;; }
function cargarLoteParaRenovar(cliId, items, rowId, listaIds) { marcarComoRenovadoEnBD(listaIds, rowId); document.querySelectorAll('tr').forEach(r =&gt; r.classList.remove('row-selected-renew')); if(rowId) { const fila = document.getElementById(rowId); if(fila) fila.classList.add('row-selected-renew'); idFilaSeleccionadaAzul = rowId; } mostrar('cuentas', true); const cliente = listaClientesLocal.find(c =&gt; c.id === cliId); clienteIdSeleccionado.value = cliId; inputBuscarCliente.value = cliente.nombre; txtElegido.innerText = `‚úÖ Renovando Lote de ${cliente.nombre}`; tipoCompra.value = items.length &gt; 1 ? &quot;combo&quot; : &quot;individual&quot;; document.getElementById(&quot;btnMasPlat&quot;).style.display = items.length &gt; 1 ? &quot;inline-block&quot; : &quot;none&quot;; plataformas.innerHTML = &quot;&quot;; items.forEach(it =&gt; { const div = document.createElement(&quot;div&quot;); div.className = &quot;fila-plataforma&quot;; div.style = &quot;margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;&quot;; div.innerHTML = `&lt;select class=&quot;tipo&quot;&gt;&lt;option value=&quot;${it.plat}&quot;&gt;${it.plat}&lt;/option&gt;&lt;/select&gt; &lt;span class=&quot;cont-correo&quot;&gt;&lt;select class=&quot;correo-select&quot;&gt;&lt;option value=&quot;${it.clave}&quot;&gt;${it.correo}&lt;/option&gt;&lt;/select&gt;&lt;/span&gt; &lt;span class=&quot;cont-clave&quot;&gt;&lt;input class=&quot;clave&quot; value=&quot;${it.clave}&quot; readonly style=&quot;width:80px&quot;&gt;&lt;/span&gt; &lt;div class=&quot;bloque-perfiles&quot; style=&quot;display:inline-block&quot;&gt;&lt;div class=&quot;item-perfil&quot;&gt;&lt;span class=&quot;cont-perfil&quot;&gt;&lt;select class=&quot;perfil-select&quot;&gt;&lt;option value=&quot;${it.perfil}&quot;&gt;${it.perfil}&lt;/option&gt;&lt;/select&gt;&lt;/span&gt; &lt;span class=&quot;cont-pin&quot;&gt;&lt;input class=&quot;pin&quot; value=&quot;${it.pin}&quot; style=&quot;width:50px&quot; readonly&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;`; plataformas.appendChild(div); }); }
/* --- FUNCION WHATSAPP PARA LOTES --- */
function enviarWhatsAppLote(idsStr) {
    const ids = idsStr.split(','); 
    const ventas = listaSuscripcionesGlobal.filter(v => ids.includes(v.id)); 
    if(ventas.length === 0) return; 
    const c = listaClientesLocal.find(cl => cl.id === ventas[0].clienteId); 
    if(!c) return; 

    // 1. FECHAS Y TIEMPO AUTOM√ÅTICO
    const hoy = new Date();
    const fechaHoy = hoy.toLocaleDateString('es-ES');
    const horaHoy = hoy.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const nombreDia = hoy.toLocaleDateString('es-ES', { weekday: 'long' });

    // 2. DATOS GENERALES
    const metodo = ventas[0].metodoPago || 'Otro';
    const fechaCompra = ventas[0].inicio || fechaHoy;
    const fechaVence = ventas[0].fin || '---';
    const valorTotal = ventas.reduce((acc, v) => acc + (parseFloat(v.valor) || 0), 0);
    
    // Conteo de dispositivos para la regla din√°mica
    const totalDispositivos = ventas.length;
    const reglaUso = totalDispositivos > 1 ? `${totalDispositivos} DISPOSITIVOS, 1 PANTALLA EN SIMULTANEO POR SERVICIO Y/O PERFIL ADQUIRIDO` : '1 DISPOSITIVO EN SIMULTANEO';

    // C√°lculo de d√≠as con el ajuste de +1
    const fVence = new Date(fechaVence);
    let diasGarantizados = '30';
    if (!isNaN(fVence.getTime())) {
        diasGarantizados = Math.ceil((fVence - hoy) / (1000 * 60 * 60 * 24)) + 1;
    }

    let detalleMsg = ''; 

    // 3. CONSTRUIMOS EL DETALLE (Tu dise√±o de forEach)
    ventas.forEach(v => { 
        detalleMsg += `%0A------------------------------------------------`;
        detalleMsg += `%0A*Informaci√≥n De La Cuenta de: ${v.plataforma}*`;
        detalleMsg += `%0Aüìß : ${v.correo}`;
        detalleMsg += `%0Aüîê : *${v.clave}*`;
        detalleMsg += `%0Aüë§ : ${v.perfil || ''}) ${c.nombre}`;
        detalleMsg += `%0Aüîí : ${v.pin || '---'}`;
        detalleMsg += `%0A------------------------------------------------`;
    }); 

    // 4. EL MENSAJE FINAL (Links integrados como texto despu√©s del eslogan)
    const msg = `Hola Estimado/a *${c.nombre}*%0A%0ATu Servicio ha sido activado exitosamente, y ya se encuentran listos para disfrutar a partir de hoy ü§©.%0A------------------------------------------------%0A*INFORMACI√ìN DEL SERVICIO:*%0A%0Aüëâüèª *VALOR DEL SERVICIO:* $${valorTotal}.%0Aüëâüèª *METODO DE PAGO:* ${metodo}.%0Aüëâüèª *CONDICIONES:* üì∫ ${reglaUso}.%0Aüëâüèª *FECHA DE COMPRA:* ${fechaCompra}.%0AüìÖ *LA FECHA DE VENCIMIENTO ES EL:* ${fechaVence}.%0A_*CON UN SERVICIO GARANTIZADO DE: üóìÔ∏è ${diasGarantizados} üóìÔ∏è D√≠as disponibles a partir de hoy ${fechaHoy}.*_%0A${detalleMsg}%0A%0AMuchas gracias por su compra, disfruta del servicio adquirido üòä.%0A%0A_Mensaje autom√°tico enviado por *MultiBot* el d√≠a ${nombreDia}, ${fechaHoy}. a las ${horaHoy}._%0A%0A*Somos MultiEntretenimiento BC* üì±üçø%0A_El mejor entretenimiento para todos üçø_%0A%0A _%0A%0Aüí° *CENTRO DE AYUDA Y GESTI√ìN* üí°%0A%0Aüì∫ Tutorial: youtube.com _(Mira este video para aprender a usar tu oficina virtual y navegar en tu panel correctamente.)_ %0A%0AüöÄ *¬°NUEVA PLATAFORMA DE AUTOGESTI√ìN!*: google.com, _Desde aqu√≠ puedes revisar tus cuentas activas, consulta tus vencimientos, realiza tus renovaciones al instante, aprovechar ofertas, y autogestionar tu hogar de manera rapida, sencilla y en tiempo real._ *(Tu ingreso personalizado es con tu numero de WhatsApp.)*`; 

    // 5. LIMPIEZA DE TEL√âFONO
    const cod = c.codigo ? c.codigo.toString().replace(/\D/g, '') : '';
    const num = c.whatsapp ? c.whatsapp.toString().replace(/\D/g, '') : '';
    const telLimpio = cod + num;

    // 6. ABRIR WHATSAPP
    window.open(`https://api.whatsapp.com/send?phone=${telLimpio}&text=${msg}`); 


}

/* --- FUNCION EDITAR MANUAL (INDIVIDUAL O LOTE) --- */
/* --- FUNCION EDITAR MANUAL CON PROTECCION DE CUENTAS BASE --- */
async function abrirEditorManualLote(idsStr) { 
    const ids = idsStr.split(','); 
    let venta = null;

    if(ids.length &gt; 1) {
        const busqueda = prompt(&quot;Esta venta tiene varios perfiles. Escribe el correo del que quieres editar:&quot;);
        venta = listaSuscripcionesGlobal.find(v =&gt; v.correo.includes(busqueda) &amp;&amp; ids.includes(v.id));
    } else {
        venta = listaSuscripcionesGlobal.find(v =&gt; v.id === ids[0]);
    }

    if(!venta) return alert(&quot;No se encontr√≥ el registro&quot;);

    /* --- BLOQUEO DE SEGURIDAD --- */
    // Buscamos si el correo de esta venta pertenece a una de tus Cuentas Base
    const snapBase = await db.collection(&quot;cuentas_base&quot;).where(&quot;correo&quot;, &quot;==&quot;, venta.correo.trim()).get();
    
    if(!snapBase.empty) {
        // Si el correo existe en el administrador, bloqueamos la edicion manual
        return alert(&quot;‚ö†Ô∏è Esta cuenta es ADMINISTRADA. Para cambiar la clave, hazlo desde el Administrador de Perfiles Base para que se actualice en todos los clientes a la vez.&quot;);
    }

    /* --- SI ES EXTERNA, PROCEDE CON LA EDICION --- */
    const nCor = prompt(&quot;Nuevo Correo (Cuenta Externa):&quot;, venta.correo); 
    if(!nCor) return; 
    const nCla = prompt(&quot;Nueva Clave (Cuenta Externa):&quot;, venta.clave); 
    if(!nCla) return; 
    const nPin = prompt(&quot;Nuevo PIN:&quot;, venta.pin); 

    await db.collection(&quot;cuentas&quot;).doc(venta.id).update({ 
        correo: nCor.trim(), 
        clave: nCla.trim(), 
        pin: nPin, 
        ultimaModificacion: new Date().toISOString() 
    }); 
    
    alert(&quot;¬°Cuenta externa actualizada!&quot;); 
    actualizarTodo(); 
}
async function filtrarCuentasParaEdicion(plataforma, div, correoActual) {

    var cont = div.getElementsByClassName(&quot;cont-correo&quot;)[0];
    if (!cont) {
        console.warn(&quot;No se encontr√≥ cont-correo&quot;);
        return;
    }

    cont.innerHTML = &quot;Cargando cuentas...&quot;;

    var snap = await db.collection(&quot;cuentas_base&quot;)
        .where(&quot;plataforma&quot;, &quot;==&quot;, plataforma)
        .get();

    if (snap.empty) {
        cont.innerHTML =
            &quot;&lt;input class='correo-select' value='&quot; + correoActual + &quot;' style='padding:6px; width:80%;'&gt;&quot;;
        return;
    }

    var html = &quot;&lt;select class='correo-select' style='padding:6px; width:80%;'&gt;&quot;;

    snap.forEach(function(doc) {
        var d = doc.data();
        var sel = (d.correo === correoActual) ? &quot;selected&quot; : &quot;&quot;;
        html += &quot;&lt;option value='&quot; + d.correo + &quot;' &quot; + sel + &quot;&gt;&quot; + d.correo + &quot;&lt;/option&gt;&quot;;
    });

    html += &quot;&lt;/select&gt;&quot;;
    cont.innerHTML = html;
}


function calcularNuevaFechaCompensacion(diasExtra) {
    if (!vencimientoOriginalParaEdicion) return;

    // Convertimos la fecha original (YYYY-MM-DD) a objeto Date
    let f = vencimientoOriginalParaEdicion.split(&quot;-&quot;);
    let fecha = new Date(f[0], f[1] - 1, f[2]);

    // Sumamos los d√≠as
    fecha.setDate(fecha.getDate() + parseInt(diasExtra || 0));

    // Formateamos de nuevo a YYYY-MM-DD
    let y = fecha.getFullYear();
    let m = (fecha.getMonth() + 1).toString().padStart(2, &quot;0&quot;);
    let d = fecha.getDate().toString().padStart(2, &quot;0&quot;);

    fechaFinalCalculadaGarantia = `${y}-${m}-${d}`;

    const info = document.getElementById(&quot;info_nueva_fecha&quot;);
    if (info) {
        info.innerHTML = `üìÖ Nueva fecha: &lt;b style=&quot;color:#27ae60&quot;&gt;${fechaFinalCalculadaGarantia}&lt;/b&gt;`;
    }
}

async function filtrarCuentas(sel) { 
    const p = sel.value; 
    if (!p) return; 
    const f = sel.parentElement; 
    const cId = clienteIdSeleccionado.value; 

    // 1. Intentar obtener cuentas de tu Administrador
    const snap = await db.collection(&quot;cuentas_base&quot;).where(&quot;plataforma&quot;, &quot;==&quot;, p).get(); 
    
    // Al momento de vender:
const idCuentaBaseSeleccionada = selectCorreo.options[selectCorreo.selectedIndex].getAttribute(&quot;data-id&quot;);

let datosVenta = {
    cliente: nombreCliente,
    correo: correoSeleccionado, // El que incluye Usuario / URL
    clave: clave,
    idReferenciaBase: idCuentaBaseSeleccionada, // ESTE ES EL IDENTIFICADOR INTERNO
    // ... resto de campos
};

    if (!snap.empty) { 
        /* --- MODO AUTOM√ÅTICO (Netflix, Disney, HBO) --- */
        let ops = '&lt;option value=&quot;&quot;&gt;Cuenta...&lt;/option&gt;'; 
        snap.forEach(doc =&gt; { ops += `&lt;option value=&quot;${doc.data().clave}&quot;&gt;${doc.data().correo.trim()}&lt;/option&gt;`; }); 

        f.querySelector(&quot;.cont-correo&quot;).innerHTML = `&lt;select class=&quot;correo-select&quot; onchange=&quot;validarDisponibilidad(this)&quot;&gt;${ops}&lt;/select&gt;`; 
        f.querySelector(&quot;.cont-clave&quot;).innerHTML = `&lt;input class=&quot;clave&quot; readonly style=&quot;width:80px&quot; placeholder=&quot;Clave&quot;&gt;`; 
        f.querySelector(&quot;.bloque-perfiles&quot;).innerHTML = `&lt;div class=&quot;item-perfil&quot;&gt;&lt;span class=&quot;cont-perfil&quot;&gt;&lt;/span&gt;&lt;span class=&quot;cont-pin&quot;&gt;&lt;/span&gt;&lt;button class=&quot;add-perfil-btn&quot; onclick=&quot;crearNuevaFilaPerfil(this)&quot;&gt;+&lt;/button&gt;&lt;/div&gt;`; 

        // Auto-selecci√≥n si ya existe cliente
        if (cId) { 
            const yaT = listaSuscripcionesGlobal.find(s =&gt; s.clienteId === cId &amp;&amp; s.plataforma === p &amp;&amp; (new Date(s.fin + &quot;T12:00:00&quot;) &gt;= new Date(hoy.getTime() - (3 * 86400000)))); 
            if (yaT) { 
                setTimeout(() =&gt; { 
                    const selC = f.querySelector(&quot;.correo-select&quot;); 
                    if (selC) { 
                        for (let i = 0; i &lt; selC.options.length; i++) { 
                            if (selC.options[i].text.trim() === yaT.correo.trim()) { 
                                selC.selectedIndex = i; 
                                validarDisponibilidad(selC); 
                                break; 
                            } 
                        } 
                    } 
                }, 60); 
            } 
        } 
    } else { 
        /* --- MODO MANUAL (IPTV, Crunchyroll, Prime y otros) --- */
        // Aqu√≠ forzamos que los contenedores se conviertan en INPUTS para escribir
        f.querySelector(&quot;.cont-correo&quot;).innerHTML = `&lt;input class=&quot;correo-select&quot; placeholder=&quot;Correo/User&quot; style=&quot;width:150px; border:1px solid #555; background:#222; color:white; padding:4px;&quot;&gt;`; 
        f.querySelector(&quot;.cont-clave&quot;).innerHTML = `&lt;input class=&quot;clave&quot; placeholder=&quot;Clave&quot; style=&quot;width:80px; border:1px solid #555; background:#222; color:white; padding:4px;&quot;&gt;`; 
        f.querySelector(&quot;.bloque-perfiles&quot;).innerHTML = `&lt;div class=&quot;item-perfil&quot; style=&quot;display:flex; gap:3px; align-items:center;&quot;&gt;
            &lt;input class=&quot;perfil-select&quot; placeholder=&quot;P&quot; style=&quot;width:35px; border:1px solid #555; background:#222; color:white; padding:4px;&quot;&gt;
            &lt;input class=&quot;pin&quot; placeholder=&quot;PIN&quot; style=&quot;width:45px; border:1px solid #555; background:#222; color:white; padding:4px;&quot;&gt;
            &lt;button class=&quot;add-perfil-btn&quot; onclick=&quot;crearNuevaFilaPerfil(this)&quot;&gt;+&lt;/button&gt;
        &lt;/div&gt;`; 
    } 
}

async function corregirFallaCuenta(idVenta) {
    const v = listaSuscripcionesGlobal.find(x =&gt; x.id === idVenta);
    if (!v) return;

    const nuevoCor = prompt(&quot;NUEVO CORREO / USUARIO:&quot;, v.correo);
    if (!nuevoCor) return;
    const nuevaCla = prompt(&quot;NUEVA CONTRASE√ëA:&quot;, v.clave);
    if (!nuevaCla) return;

    try {
        const batch = db.batch();
        const ahora = new Date().toISOString();
        
        // ESTE ES EL ID ALFANUM√âRICO (El c√≥digo raro de la cuenta base)
        const idBase = v.idReferenciaBase; 

        // A. Actualizar al cliente que estamos editando
        batch.update(db.collection(&quot;suscripciones&quot;).doc(idVenta), {
            correo: nuevoCor.trim(),
            clave: nuevaCla.trim(),
            ultimaModificacion: ahora
        });

        // B. ACTUALIZACI√ìN EN CASCADA
        if (idBase) {
            // 1. Actualizar la ra√≠z en 'cuentas_base'
            batch.update(db.collection(&quot;cuentas_base&quot;).doc(idBase), {
                correo: nuevoCor.trim(),
                clave: nuevaCla.trim(),
                ultimaModificacion: ahora
            });

            // 2. Buscar a TODOS los clientes que tengan ese mismo ID base
            const snapOtros = await db.collection(&quot;suscripciones&quot;)
                .where(&quot;idReferenciaBase&quot;, &quot;==&quot;, idBase)
                .get();

            snapOtros.forEach(docOtro =&gt; {
                if (docOtro.id !== idVenta) {
                    batch.update(docOtro.ref, {
                        correo: nuevoCor.trim(),
                        clave: nuevaCla.trim(),
                        ultimaModificacion: ahora
                    });
                }
            });
        }

        await batch.commit();
        alert(&quot;‚úÖ Sincronizaci√≥n Total Completada.&quot;);
        actualizarTodo();

    } catch (e) {
        alert(&quot;‚ùå Error: &quot; + e.message);
    }
}
function abrirModalEditarCuenta(id, correo, clave) {
    document.getElementById(&quot;editBaseId&quot;).value = id;
    document.getElementById(&quot;modalCorreo&quot;).value = correo;
    document.getElementById(&quot;modalClave&quot;).value = clave;
    document.getElementById(&quot;modalEditarCuenta&quot;).style.display = &quot;block&quot;;
}

function cerrarModalEditarCuenta() {
    document.getElementById(&quot;modalEditarCuenta&quot;).style.display = &quot;none&quot;;
}
async function guardarEdicionModal() {
    const id = document.getElementById(&quot;editBaseId&quot;).value;
    const nuevoCorreo = document.getElementById(&quot;modalCorreo&quot;).value.trim();
    const nuevaClave = document.getElementById(&quot;modalClave&quot;).value.trim();
    const ahora = new Date().toISOString();

    try {
        // 1. Cuenta base
        await db.collection(&quot;cuentas_base&quot;).doc(id).update({
            correo: nuevoCorreo,
            clave: nuevaClave,
            ultimaModificacion: ahora
        });

        // 2. Cascada TOTAL por ID
        const snap = await db.collection(&quot;cuentas&quot;)
            .where(&quot;idReferenciaBase&quot;, &quot;==&quot;, id)
            .get();

        const batch = db.batch();
        snap.forEach(doc =&gt; {
            batch.update(doc.ref, {
                correo: nuevoCorreo,
                clave: nuevaClave,
                ultimaModificacion: ahora
            });
        });
        await batch.commit();

        cerrarModalEditarCuenta();
        actualizarTodo();
        alert(&quot;‚úÖ Servicio actualizado correctamente&quot;);

    } catch (e) {
        alert(&quot;‚ùå Error: &quot; + e.message);
    }
}

async function guardarServicioManual() {
    const plat = document.getElementById(&quot;selPlataformaOtros&quot;).value;
    let corr = document.getElementById(&quot;inpCorreoOtros&quot;).value.trim();
    const clav = document.getElementById(&quot;inpClaveOtros&quot;).value.trim();
    const urlIptv = document.getElementById(&quot;inpUrlIptv&quot;).value.trim();
    
    

    if(!corr || !clav) return alert(&quot;Faltan datos obligatorios (Usuario y Clave)&quot;);

    // L√ìGICA DE FUSI√ìN PARA IPTV
    if (plat === &quot;IPTV&quot; &amp;&amp; urlIptv !== &quot;&quot;) {
        // Guardamos el usuario y la URL separados por una diagonal
        corr = `${corr} / ${urlIptv}`;
    }

    try {
        await db.collection(&quot;cuentas_base&quot;).add({
            plataforma: plat,
            correo: corr, // Aqu√≠ ya va la uni√≥n si es IPTV
            clave: clav,
            // Guardamos la URL por separado tambi√©n por si la necesitas luego
            url: urlIptv, 
            ultimaModificacion: new Date().toISOString()
        });

        alert(&quot;‚úÖ Servicio Guardado: &quot; + corr);
        cerrarModalOtros();
        cargarCuentasBase(); // Refresca la tabla autom√°ticamente
    } catch (e) {
        alert(&quot;‚ùå Error al guardar: &quot; + e.message);
    }
}


/* --- PARTE 1: GESTI√ìN DE CUENTAS Y AUTO-SELECCI√ìN --- */
async function filtrarCuentas(sel) { const p = sel.value; if (!p) return; const f = sel.parentElement; const clienteId = clienteIdSeleccionado.value; const snap = await db.collection(&quot;cuentas_base&quot;).where(&quot;plataforma&quot;, &quot;==&quot;, p).get(); let ops = '&lt;option value=&quot;&quot;&gt;Cuenta...&lt;/option&gt;'; snap.forEach(doc =&gt; { const d = doc.data(); ops += `&lt;option value=&quot;${d.clave}&quot;&gt;${d.correo.trim()}&lt;/option&gt;`; }); f.querySelector(&quot;.cont-correo&quot;).innerHTML = `&lt;select class=&quot;correo-select&quot; onchange=&quot;validarDisponibilidad(this)&quot;&gt;${ops}&lt;/select&gt;`; f.querySelector(&quot;.cont-clave&quot;).innerHTML = `&lt;input class=&quot;clave&quot; readonly style=&quot;width:80px&quot;&gt;`; f.querySelector(&quot;.bloque-perfiles&quot;).innerHTML = `&lt;div class=&quot;item-perfil&quot;&gt;&lt;span class=&quot;cont-perfil&quot;&gt;&lt;/span&gt;&lt;span class=&quot;cont-pin&quot;&gt;&lt;/span&gt;&lt;button class=&quot;add-perfil-btn&quot; onclick=&quot;crearNuevaFilaPerfil(this)&quot;&gt;+&lt;/button&gt;&lt;/div&gt;`; if (clienteId) { const yaTiene = listaSuscripcionesGlobal.find(s =&gt; s.clienteId === clienteId &amp;&amp; s.plataforma.trim().toLowerCase() === p.trim().toLowerCase() &amp;&amp; (new Date(s.fin + &quot;T12:00:00&quot;) &gt;= new Date(hoy.getTime() - (7 * 86400000)))); if (yaTiene) { setTimeout(() =&gt; { const selCorreo = f.querySelector(&quot;.correo-select&quot;); if (!selCorreo) return; let enc = false; for (let i = 0; i &lt; selCorreo.options.length; i++) { if (selCorreo.options[i].text.trim().toLowerCase() === yaTiene.correo.trim().toLowerCase()) { selCorreo.selectedIndex = i; enc = true; break; } } if (enc) { validarDisponibilidad(selCorreo); selCorreo.style.border = &quot;2px solid #28a745&quot;; selCorreo.style.backgroundColor = &quot;#e8f5e9&quot;; } }, 60); } } }



/* --- PARTE 2: RENDERIZADO DE PERFILES Y PIN (S√çMBOLO ESPECIAL) --- */
function renderizarSelectPerfil(it, plat, corr) { const cId = clienteIdSeleccionado.value; const contP = it.querySelector(&quot;.cont-perfil&quot;); it.querySelector(&quot;.cont-pin&quot;).innerHTML = `&lt;input class=&quot;pin&quot; style=&quot;width:50px&quot; readonly&gt;`; contP.innerHTML = `&lt;select class=&quot;perfil-select&quot; onchange=&quot;actualizarPin(this)&quot;&gt;&lt;option value=&quot;&quot;&gt;P...&lt;/option&gt;&lt;/select&gt;`; const selP = contP.querySelector(&quot;.perfil-select&quot;); const max = plat === &quot;Disney&quot; ? 7 : 5; const margenVencido = new Date(hoy.getTime() - (3 * 86400000)); const ocup = listaSuscripcionesGlobal.filter(s =&gt; s.correo === corr &amp;&amp; s.plataforma.trim().toLowerCase() === plat.trim().toLowerCase() &amp;&amp; new Date(s.fin+&quot;T12:00:00&quot;) &gt;= margenVencido); const miP = ocup.find(s =&gt; s.clienteId === cId); for(let i=1; i&lt;=max; i++) { const o = ocup.find(x =&gt; parseInt(x.perfil) === i); const opt = document.createElement(&quot;option&quot;); opt.value = i; if(o) { const n = o.perfil_etiqueta ? (o.perfil_etiqueta.split('. ')[1] || 'Ocup') : 'Ocup'; const esVencidoReciente = new Date(o.fin + &quot;T12:00:00&quot;) &lt; hoy; opt.text = `P${i} ${o.clienteId === cId ? '(Tu Perfil)' : '('+n+')'} ${esVencidoReciente ? '[V]' : ''}`; if(o.clienteId !== cId) opt.disabled = true; } else { opt.text = `P${i} (Libre)`; } selP.appendChild(opt); } if(miP) { selP.value = miP.perfil; actualizarPin(selP); } }

/* --- PARTE 3: SINCRONIZACI√ìN AUTOM√ÅTICA DE CLAVES --- */


/* --- PARTE 4: UTILIDADES Y PIN REGLA --- */
function actualizarPin(sel) { const it = sel.closest(&quot;.item-perfil&quot;); const val = parseInt(sel.value); it.querySelector(&quot;.pin&quot;).value = isNaN(val) ? &quot;&quot; : 1000 + val; }
function validarDisponibilidad(sel){ const f=sel.parentElement.parentElement; f.querySelector(&quot;.clave&quot;).value=sel.value; f.querySelectorAll(&quot;.item-perfil&quot;).forEach(it=&gt;renderizarSelectPerfil(it, f.querySelector(&quot;.tipo&quot;).value, sel.options[sel.selectedIndex].text)); }
function eliminarCuentaBase(id) { if (confirm(&quot;¬øEliminar?&quot;)) { db.collection(&quot;cuentas_base&quot;).doc(id).delete().then(() =&gt; actualizarTodo()); } }

 

async function cargarParaModificar(idsVenta) {
    try {

        if (!idsVenta) return alert(&quot;ID inv√°lido&quot;);

        var listaIds = idsVenta.split(&quot;,&quot;);
        idModificando = listaIds;

        plataformas.innerHTML = &quot;&quot;;

        if(typeof mostrar === 'function') mostrar(&quot;cuentas&quot;);

        // Tomamos el PRIMER registro como base del cliente
        const primerDoc = await db.collection(&quot;cuentas&quot;).doc(listaIds[0].trim()).get();
        if (!primerDoc.exists) return alert(&quot;No se encontr√≥ el registro&quot;);

        const base = primerDoc.data();

        // Cliente bloqueado
        clienteIdSeleccionado.value = base.clienteId || &quot;&quot;;
        inputBuscarCliente.value = base.cliente_nombre || &quot;Cliente&quot;;
        inputBuscarCliente.disabled = true;

        // Fechas base
        vencimientoOriginalParaEdicion = base.fin;
        fechaFinalCalculadaGarantia = base.fin;

        txtElegido.innerHTML = `üõ†Ô∏è &lt;b style=&quot;color:#ff9800&quot;&gt;GARANT√çA / EDICI√ìN M√öLTIPLE&lt;/b&gt;`;
        btnGuardar.innerText = &quot;Actualizar y Guardar&quot;;

        // === BLOQUES POR CADA CUENTA ===
        for (var i = 0; i &lt; listaIds.length; i++) {

            const idDoc = listaIds[i].trim();
            const docSnap = await db.collection(&quot;cuentas&quot;).doc(idDoc).get();
            if (!docSnap.exists) continue;

            const v = docSnap.data();

            const div = document.createElement(&quot;div&quot;);
            div.className = &quot;fila-plataforma&quot;;
            div.setAttribute(&quot;data-id&quot;, idDoc);
            div.style = &quot;background:#ffffff; padding:25px; border:2px solid #e67e22; border-radius:12px; margin-bottom:15px; color:#333;&quot;;

            div.innerHTML = `
                &lt;input type=&quot;hidden&quot; class=&quot;tipo&quot; value=&quot;${v.plataforma}&quot;&gt;

                &lt;div style=&quot;text-align:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px; color:#000;&quot;&gt;
                    &lt;b&gt;Servicio:&lt;/b&gt; ${v.plataforma} |
                    &lt;b&gt;Vence:&lt;/b&gt; ${v.fin}
                &lt;/div&gt;

                &lt;div style=&quot;display:flex; flex-direction:column; gap:12px; align-items:center;&quot;&gt;

                    &lt;div style=&quot;width:100%; text-align:center;&quot;&gt;
                        &lt;label style=&quot;font-weight:bold; color:#000;&quot;&gt;Seleccionar Nueva Cuenta:&lt;/label&gt;&lt;br&gt;
                        &lt;span class=&quot;cont-correo&quot;&gt;Cargando cuentas base...&lt;/span&gt;
                    &lt;/div&gt;

                    &lt;div style=&quot;display:flex; gap:10px; justify-content:center; background:#f4f4f4; padding:15px; border-radius:8px; width:100%; border:1px solid #ddd;&quot;&gt;
                        &lt;div class=&quot;item-perfil&quot; style=&quot;display:contents;&quot;&gt;

                            &lt;div style=&quot;text-align:center;&quot;&gt;
                                &lt;label style=&quot;font-size:11px; font-weight:bold; color:#000;&quot;&gt;CLAVE&lt;/label&gt;
                                &lt;input class=&quot;clave&quot; value=&quot;${v.clave}&quot; readonly
                                    style=&quot;width:120px; padding:8px; text-align:center; background:#eee; border:1px solid #ccc; color:#000;&quot;&gt;
                            &lt;/div&gt;

                            &lt;div style=&quot;text-align:center;&quot;&gt;
                                &lt;label style=&quot;font-size:11px; font-weight:bold; color:#000;&quot;&gt;P&lt;/label&gt;
                                &lt;input class=&quot;perfil-select&quot; value=&quot;${v.perfil}&quot; readonly
                                    style=&quot;width:45px; padding:8px; text-align:center; background:#eee; color:#000;&quot;&gt;
                            &lt;/div&gt;

                            &lt;div style=&quot;text-align:center;&quot;&gt;
                                &lt;label style=&quot;font-size:11px; font-weight:bold; color:#000;&quot;&gt;PIN&lt;/label&gt;
                                &lt;input class=&quot;pin&quot; value=&quot;${v.pin}&quot; readonly
                                    style=&quot;width:55px; padding:8px; text-align:center; background:#eee; color:#000;&quot;&gt;
                            &lt;/div&gt;

                        &lt;/div&gt;
                    &lt;/div&gt;

                &lt;/div&gt;
            `;

            plataformas.appendChild(div);

            // üîë Cargar cuentas seg√∫n servicio
            await filtrarCuentasParaEdicion(v.plataforma, div, v.correo);
        }

        // === D√çAS EXTRA GENERALES (UNO SOLO POR COMBO) ===
        const divExtra = document.createElement(&quot;div&quot;);
        divExtra.style = &quot;background:#d5f5e3; padding:12px; border-radius:8px; border:1px solid #2ecc71; text-align:center; margin-top:10px;&quot;;
        divExtra.innerHTML = `
            &lt;label style=&quot;font-weight:bold; color:#145a32;&quot;&gt;üéÅ D√≠as Extra (GENERAL)&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;number&quot; id=&quot;dias_regalo&quot; value=&quot;0&quot; min=&quot;0&quot;
                oninput=&quot;calcularNuevaFechaCompensacion(this.value)&quot;
                style=&quot;width:80px; padding:6px; text-align:center; font-weight:bold; color:#27ae60; border:1px solid #27ae60;&quot;&gt;
        `;
        plataformas.appendChild(divExtra);

        // === NOTA GENERAL ===
        const divNota = document.createElement(&quot;div&quot;);
        divNota.style = &quot;margin-top:10px; background:#fff3cd; padding:10px; border-radius:8px; border:1px solid #ffeeba;&quot;;
        divNota.innerHTML = `
            &lt;label style=&quot;font-weight:bold; color:#856404;&quot;&gt;üìù Nota de cambio:&lt;/label&gt;
            &lt;textarea id=&quot;txt_obs_cambio&quot; style=&quot;width:100%; height:50px; color:#000; background:#fff;&quot;&gt;&lt;/textarea&gt;
            &lt;div id=&quot;info_nueva_fecha&quot; style=&quot;margin-top:5px; font-weight:bold; color:#2980b9; text-align:center;&quot;&gt;&lt;/div&gt;
        `;
        plataformas.appendChild(divNota);

        window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (e) {
        alert(&quot;Error: &quot; + e.message);
    }
}




// Nueva funci√≥n de apoyo para llenar el select en modo edici√≥n
async function filtrarCuentasParaEdicion(plataforma, filaDiv, correoActual) {
    const snap = await db.collection(&quot;cuentas_base&quot;).where(&quot;plataforma&quot;, &quot;==&quot;, plataforma).get();
    let ops = `&lt;option value=&quot;&quot;&gt;-- Selecciona Cuenta --&lt;/option&gt;`;
    
    snap.forEach(doc =&gt; {
        const d = doc.data();
        const selected = d.correo.trim() === correoActual.trim() ? &quot;selected&quot; : &quot;&quot;;
        ops += `&lt;option value=&quot;${d.clave}&quot; ${selected}&gt;${d.correo.trim()}&lt;/option&gt;`;
    });

    filaDiv.querySelector(&quot;.cont-correo&quot;).innerHTML = `
        &lt;select class=&quot;correo-select&quot; style=&quot;width:200px; padding:5px;&quot; onchange=&quot;this.parentElement.parentElement.parentElement.querySelector('.clave').value = this.value&quot;&gt;
            ${ops}
        &lt;/select&gt;`;
}

function actualizarPin(sel) { const it = sel.closest(&quot;.item-perfil&quot;); const val = parseInt(sel.value); it.querySelector(&quot;.pin&quot;).value = isNaN(val) ? &quot;&quot; : 1000 + val; }
async function guardarCuentas() {
    // 1. Obtener el ID del cliente de forma segura
    const idCli = clienteIdSeleccionado.value;
    if (!idCli) return alert(&quot;Selecciona un cliente&quot;);

    const marca = Date.now();
    let promesas = [];
    
    // Capturar la nota de garant√≠a y los d√≠as extra del formulario de edici√≥n
    const notaGarantia = document.getElementById(&quot;txt_obs_cambio&quot;) ? document.getElementById(&quot;txt_obs_cambio&quot;).value : &quot;&quot;;
    const diasRegalo = document.getElementById(&quot;dias_regalo&quot;) ? parseInt(document.getElementById(&quot;dias_regalo&quot;).value) : 0;

    // 2. Recorrer la fila de la plataforma (solo habr√° una en modo edici√≥n)
    document.querySelectorAll(&quot;.fila-plataforma&quot;).forEach(f =&gt; {
        const cSel = f.querySelector(&quot;.correo-select&quot;);
        if (!cSel || !cSel.value) return;

        const plat = f.querySelector(&quot;.tipo&quot;).value;
        
        // REGLA CR√çTICA: Si es un SELECT (venta nueva) sacamos el text. 
        // Si es un INPUT u otra cosa (edici√≥n), sacamos el value.
        const correoFinal = cSel.tagName === &quot;SELECT&quot; ? cSel.options[cSel.selectedIndex].text : cSel.value;
        const claveFinal = f.querySelector(&quot;.clave&quot;).value;

        f.querySelectorAll(&quot;.item-perfil&quot;).forEach(it =&gt; {
            const p = it.querySelector(&quot;.perfil-select&quot;).value;
            
            // Construimos el objeto de datos que se enviar√° a Firebase
            let objetoData = {
                clienteId: idCli,
                plataforma: plat,
                correo: correoFinal,
                clave: claveFinal,
                perfil: p,
                perfil_etiqueta: `${p}. ${inputBuscarCliente.value}`,
                pin: it.querySelector(&quot;.pin&quot;).value,
                // Si es edici√≥n, usamos la fecha compensada. Si es venta, la fecha fin normal.
                fin: (idModificando &amp;&amp; typeof fechaFinalCalculadaGarantia !== 'undefined' &amp;&amp; fechaFinalCalculadaGarantia) ? fechaFinalCalculadaGarantia : fechaFin.value,
                ultimaModificacion: new Date().toISOString()
            };

            // 3. ¬øES EDICI√ìN O ES VENTA NUEVA?
            if (idModificando) {
                // AGREGAMOS DATOS DE AUDITOR√çA DE GARANT√çA
                objetoData.nota_cambio = notaGarantia;
                objetoData.dias_extra_regalados = diasRegalo;
                objetoData.estado_edicion = &quot;Garant√≠a Aplicada&quot;;

                // ACTUALIZAMOS EL DOCUMENTO EXISTENTE
                promesas.push(db.collection(&quot;cuentas&quot;).doc(idModificando).update(objetoData));
            } else {
                // ES UNA VENTA NUEVA: Agregamos campos que solo lleva la venta inicial
                objetoData.inicio = fechaInicio.value;
                objetoData.metodoPago = metodoPago.value;
                objetoData.valor = valorPago.value;
                objetoData.fechaRegistro = marca;
                
                promesas.push(db.collection(&quot;cuentas&quot;).add(objetoData));
            }
        });
    });

    if (promesas.length === 0) return alert(&quot;No hay datos para procesar&quot;);

    try {
        await Promise.all(promesas);
        alert(idModificando ? &quot;‚úÖ Garant√≠a guardada correctamente&quot; : &quot;‚úÖ Venta guardada con √©xito&quot;);

        // 4. LIMPIEZA TOTAL Y DESBLOQUEO
        idModificando = null;
        fechaFinalCalculadaGarantia = &quot;&quot;;
        
        // Habilitar campos para la siguiente operaci√≥n
        inputBuscarCliente.disabled = true;
        if(document.getElementById(&quot;fechaInicio&quot;)) document.getElementById(&quot;fechaInicio&quot;).disabled = false;
        if(document.getElementById(&quot;fechaFin&quot;)) document.getElementById(&quot;fechaFin&quot;).disabled = false;
        if(document.getElementById(&quot;diasVenta&quot;)) document.getElementById(&quot;diasVenta&quot;).disabled = false;

        reiniciarFormVentas();
        actualizarTodo();

    } catch (err) {
        console.error(&quot;Error al guardar:&quot;, err);
        alert(&quot;‚ùå Error al conectar con la base de datos&quot;);
    }
}

function dibujarSeccionOtrosAdmin(plataforma, cuentasBase, ventasActivas) {
    let html = `&lt;div class=&quot;seccion-servicio&quot; style=&quot;margin-bottom: 30px; font-family: Arial, sans-serif;&quot;&gt;
        &lt;div style=&quot;background: #2c3e50; color: white; padding: 12px; font-weight: bold; border-radius: 8px 8px 0 0; text-align: center;&quot;&gt;
            üñ•Ô∏è MONITOREO GLOBAL: ${plataforma.toUpperCase()}
        &lt;/div&gt;
        &lt;table style=&quot;width: 100%; border-collapse: collapse; background: white; color: black; font-size: 12px; border: 1px solid #ccc;&quot;&gt;
            &lt;thead style=&quot;background: #f8f9fa; border-bottom: 2px solid #2c3e50;&quot;&gt;
                &lt;tr&gt;
                    &lt;th style=&quot;padding: 10px; text-align: left; border-right: 1px solid #ddd;&quot;&gt;Cuenta Correo&lt;/th&gt;
                    &lt;th style=&quot;border-right: 1px solid #ddd;&quot;&gt;Clave&lt;/th&gt;
                    &lt;th&gt;P1&lt;/th&gt;&lt;th&gt;P2&lt;/th&gt;&lt;th&gt;P3&lt;/th&gt;&lt;th&gt;P4&lt;/th&gt;&lt;th&gt;P5&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;`;

    cuentasBase.forEach(cuenta =&gt; {
        html += `&lt;tr style=&quot;border-bottom: 1px solid #eee;&quot;&gt;
            &lt;td style=&quot;padding: 8px; font-weight: bold; border-right: 1px solid #ddd; background: #fafafa;&quot;&gt;${cuenta.correo}&lt;/td&gt;
            &lt;td style=&quot;padding: 5px; text-align: center; border-right: 1px solid #ddd;&quot;&gt;${cuenta.clave}&lt;/td&gt;`;

        // Generamos las 5 columnas de perfiles
        for (let i = 1; i &lt;= 5; i++) {
            // BUSCADOR INTERNO: Filtra si este correo y perfil est√°n en el historial de ventas
            const asignacion = ventasActivas.find(v =&gt; 
                v.correo.trim().toLowerCase() === cuenta.correo.trim().toLowerCase() &amp;&amp;
                v.perfil.toString() === i.toString() &amp;&amp;
                v.plataforma.trim().toLowerCase() === plataforma.trim().toLowerCase()
            );

            if (asignacion) {
                // 1. C√ÅLCULO DE D√çAS RESTANTES
                const hoy = new Date();
                const fechaFin = new Date(asignacion.fin);
                const diferencia = Math.ceil((fechaFin - hoy) / (1000 * 60 * 60 * 24));

                // 2. L√ìGICA DE SEM√ÅFORO (Igual a Netflix)
                let colorFondo = &quot;#27ae60&quot;; // Verde (OK)
                let colorTexto = &quot;white&quot;;

                if (diferencia &lt;= 0) {
                    colorFondo = &quot;#c0392b&quot;; // Rojo (Vencido)
                } else if (diferencia &lt;= 3) {
                    colorFondo = &quot;#f1c40f&quot;; // Amarillo (Pr√≥ximo)
                    colorTexto = &quot;black&quot;;
                }

                // 3. DISE√ëO DE LA CELDA OCUPADA
                html += `&lt;td style=&quot;background: ${colorFondo}; color: ${colorTexto}; padding: 6px; text-align: center; border: 1px solid #fff; min-width: 90px;&quot;&gt;
                    &lt;div style=&quot;font-weight: bold; font-size: 10px; border-bottom: 1px solid rgba(255,255,255,0.4); margin-bottom: 3px;&quot;&gt;
                        ${diferencia &lt;= 0 ? 'VENCIDO' : 'Faltan ' + diferencia + 'd'}
                    &lt;/div&gt;
                    &lt;div style=&quot;font-size: 9px; line-height: 1;&quot;&gt;
                        üë§ ${asignacion.cliente_nombre || &quot;Sin Nombre&quot;}
                    &lt;/div&gt;
                    &lt;div style=&quot;font-size: 8px; margin-top: 2px; opacity: 0.8;&quot;&gt;
                        üìÖ ${asignacion.fin}
                    &lt;/div&gt;
                &lt;/td&gt;`;
            } else {
                // PERFIL LIBRE
                html += `&lt;td style=&quot;background: #ffffff; color: #bdc3c7; text-align: center; font-style: italic; border: 1px solid #f0f0f0;&quot;&gt;
                    Libre
                &lt;/td&gt;`;
            }
        }
        html += `&lt;/tr&gt;`;
    });

    html += `&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;`;
    return html;
}
function buscarClienteHibrido(){ const txt=inputBuscarCliente.value.toLowerCase(); listaSugerencias.innerHTML=&quot;&quot;; const filtrados=listaClientesLocal.filter(c=&gt;c.nombre.toLowerCase().includes(txt) || c.whatsapp.includes(txt)); if(filtrados.length&gt;0){ filtrados.forEach(c=&gt;{ const div=document.createElement(&quot;div&quot;); div.className=&quot;sugerencia-item&quot;; div.style=&quot;padding:10px; cursor:pointer; border-bottom:1px solid #eee&quot;; div.innerHTML=`üë§ &lt;b&gt;${c.nombre}&lt;/b&gt; &lt;span style=&quot;float:right; color:gray; font-size:15px;&quot;&gt;${c.whatsapp}&lt;/span&gt;`; div.onclick=()=&gt;{ clienteIdSeleccionado.value=c.id; inputBuscarCliente.value=c.nombre; txtElegido.innerText=`‚úÖ Seleccionado: ${c.nombre} (${c.whatsapp})`; listaSugerencias.style.display=&quot;none&quot;; }; listaSugerencias.appendChild(div); }); listaSugerencias.style.display=&quot;block&quot;; } else { listaSugerencias.style.display=&quot;none&quot;; } }
function confirmarReinicioForm() { if(confirm(&quot;¬øLimpiar formulario?&quot;)) reiniciarFormVentas(); }
function reiniciarFormVentas() { idModificando = null; // Limpiamos el ID de edici√≥n
    inputBuscarCliente.value = &quot;&quot;;
    inputBuscarCliente.disabled = false; // &lt;-- ESTA L√çNEA DESBLOQUEA EL BUSCADOR
    clienteIdSeleccionado.value = &quot;&quot;; plataformas.innerHTML = &quot;&quot;; inputBuscarCliente.value = &quot;&quot;; clienteIdSeleccionado.value = &quot;&quot;; txtElegido.innerText = &quot;&quot;; valorPago.value = &quot;&quot;; metodoPago.value = &quot;Transferencia&quot;; tipoCompra.value = &quot;individual&quot;; cambiarModoCompra(); }
function validarDisponibilidad(sel){ const f=sel.parentElement.parentElement; f.querySelector(&quot;.clave&quot;).value=sel.value; f.querySelectorAll(&quot;.item-perfil&quot;).forEach(it=&gt;renderizarSelectPerfil(it, f.querySelector(&quot;.tipo&quot;).value, sel.options[sel.selectedIndex].text)); }
function crearNuevaFilaPerfil(btn){ const bloque=btn.closest(&quot;.bloque-perfiles&quot;); const divExtra=document.createElement(&quot;div&quot;); divExtra.className=&quot;item-perfil extra-perfil&quot;; divExtra.innerHTML=`&lt;span class=&quot;cont-perfil&quot;&gt;&lt;/span&gt;&lt;span class=&quot;cont-pin&quot;&gt;&lt;/span&gt;&lt;button class=&quot;delete-btn&quot; style=&quot;padding:4px 8px; margin-left:5px&quot; onclick=&quot;this.parentElement.remove()&quot;&gt;x&lt;/button&gt;`; bloque.appendChild(divExtra); renderizarSelectPerfil(divExtra, btn.closest(&quot;.fila-plataforma&quot;).querySelector(&quot;.tipo&quot;).value, btn.closest(&quot;.fila-plataforma&quot;).querySelector(&quot;.correo-select&quot;).options[btn.closest(&quot;.fila-plataforma&quot;).querySelector(&quot;.correo-select&quot;).selectedIndex].text); }
function cargarClientes(){ db.collection(&quot;clientes&quot;).get().then(s=&gt;{ listaClientesLocal=[]; s.forEach(d=&gt;{ const c=d.data(); const servs=listaSuscripcionesGlobal.filter(s=&gt;s.clienteId===d.id); const activos=servs.filter(ser=&gt;Math.ceil((new Date(ser.fin+&quot;T12:00:00&quot;)-hoy)/(1000*60*60*24))&gt;-3).length; listaClientesLocal.push({id:d.id,...c,cantServiciosActivos:activos,servsData:servs}); }); renderizarTablaClientes(); cargarVentasVencimientos(); }); }
function cambiarModoCompra(){ plataformas.innerHTML=&quot;&quot;; document.getElementById(&quot;btnMasPlat&quot;).style.display=tipoCompra.value===&quot;combo&quot;?&quot;inline-block&quot;:&quot;none&quot;; agregarPlataforma(); calcularFechaFin(); }
function calcularFechaFin(){ if(!fechaInicio.value) return; const f=new Date(fechaInicio.value+&quot;T12:00:00&quot;); f.setDate(f.getDate()+Number(dias.value)); fechaFin.value=f.toISOString().split(&quot;T&quot;)[0]; }
/* --- 1. FUNCI√ìN PARA CREAR LA FILA (Asegura los contenedores correctos) --- */
function agregarPlataforma(){ 
    const div=document.createElement(&quot;div&quot;); 
    div.className=&quot;fila-plataforma&quot;; 
    div.style=&quot;margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;&quot;; 
    div.innerHTML=`&lt;select class=&quot;tipo&quot; onchange=&quot;filtrarCuentas(this)&quot;&gt;
        &lt;option value=&quot;&quot;&gt;Plataforma...&lt;/option&gt;
        &lt;option value=&quot;Netflix&quot;&gt;Netflix&lt;/option&gt;
        &lt;option value=&quot;Disney&quot;&gt;Disney&lt;/option&gt;
        &lt;option value=&quot;HBO&quot;&gt;HBO MAX&lt;/option&gt;
        &lt;option value=&quot;Prime Video&quot;&gt;Prime Video&lt;/option&gt;
        &lt;option value=&quot;IPTV&quot;&gt;IPTV&lt;/option&gt;
        &lt;option value=&quot;Crunchyroll&quot;&gt;Crunchyroll&lt;/option&gt;
    &lt;/select&gt; 
    &lt;span class=&quot;cont-correo&quot;&gt;&lt;/span&gt; 
    &lt;span class=&quot;cont-clave&quot;&gt;&lt;/span&gt; 
    &lt;div class=&quot;bloque-perfiles&quot; style=&quot;display:inline-block&quot;&gt;&lt;/div&gt;`; 
    plataformas.appendChild(div); 
}

function mostrar(id, esRenovacion = false){ 
    document.querySelectorAll(&quot;.content&gt;div&quot;).forEach(d=&gt;d.style.display=&quot;none&quot;); 
    document.getElementById(id).style.display=&quot;block&quot;; 
    if(id === 'cuentas' &amp;&amp; !esRenovacion) {
        reiniciarFormVentas();
    }
}

function loginUser(){ auth.signInWithEmailAndPassword(email.value,password.value).catch(e=&gt;alert(e.message)); }
function logout(){ auth.signOut(); }
function eliminarCliente(id){ if(confirm(&quot;¬øEliminar?&quot;)) db.collection(&quot;clientes&quot;).doc(id).delete().then(()=&gt;actualizarTodo()); }
function filtrarTablaClientes(){ const bus=filtroCliente.value.toLowerCase(); const filas=bodyClientes.getElementsByTagName(&quot;tr&quot;); for(let f of filas) f.style.display=f.innerText.toLowerCase().includes(bus)?&quot;&quot;:&quot;none&quot;; }
function filtrarHistorialVentas(){ const bus=busquedaHistorial.value.toLowerCase(); const filas=document.getElementById(&quot;bodyVentasHistorial&quot;).getElementsByTagName(&quot;tr&quot;); for(let f of filas) f.style.display=f.innerText.toLowerCase().includes(bus)?&quot;&quot;:&quot;none&quot;; }

// -------------------------------------------------------------------------
// CARGAR ADMIN PERFILES (CON LOS CAMBIOS SOLICITADOS)
// -------------------------------------------------------------------------
async function cargarAdminPerfiles() {
    const tablas = { 
        'Netflix': document.getElementById(&quot;tablaNetflixBody&quot;), 
        'Disney': document.getElementById(&quot;tablaDisneyBody&quot;),
        'HBO': document.getElementById(&quot;tablaHBOBody&quot;),
        'OTROS': document.getElementById(&quot;tablaOtrosBody&quot;)
    };

    Object.values(tablas).forEach(t =&gt; { if(t) t.innerHTML = &quot;&quot;; });
    const hoy = new Date();

    try {
        const [snapBase, snapSusc] = await Promise.all([
            db.collection(&quot;cuentas_base&quot;).get(),
            db.collection(&quot;suscripciones&quot;).get()
        ]);

        let todosLosDocs = [];
        snapBase.forEach(doc =&gt; todosLosDocs.push({ id: doc.id, d: doc.data(), col: 'cuentas_base' }));
        snapSusc.forEach(doc =&gt; todosLosDocs.push({ id: doc.id, d: doc.data(), col: 'suscripciones' }));

        todosLosDocs.forEach(item =&gt; {
            const d = item.d;
            const id = item.id;
            const colOrigen = item.col;
            
            let body = tablas[d.plataforma] || tablas['OTROS']; 
            if (!body) return;

            let numP = d.plataforma === 'Disney' ? 7 : (body === tablas['OTROS'] ? 6 : 5);
            let celdas = &quot;&quot;;

            for (let i = 1; i &lt;= numP; i++) {
                const asig = listaSuscripcionesGlobal.find(s =&gt; 
                    s.correo === d.correo &amp;&amp; s.plataforma === d.plataforma &amp;&amp; parseInt(s.perfil) === i
                );
                let cl = &quot;p-libre&quot;, txt = &quot;Libre&quot;;
                if (asig) {
                    const diff = Math.ceil((new Date(asig.fin + &quot;T12:00:00&quot;) - hoy) / (1000 * 60 * 60 * 24)) - 1;
                    if(diff &gt; -7) {
                        cl = diff &gt; 5 ? &quot;p-verde&quot; : (diff &gt;= 0 ? &quot;p-amarillo&quot; : &quot;p-rojo&quot;);
                        const nombreC = asig.perfil_etiqueta ? (asig.perfil_etiqueta.split('. ')[1] || 'Ocupado') : 'Ocupado';
                        txt = `&lt;div style=&quot;line-height:1&quot;&gt;${diff &lt; 0 ? 'Vencido' : 'Faltan '+diff+'d'}&lt;br&gt;&lt;small style=&quot;font-size:13px&quot;&gt;${nombreC}&lt;/small&gt;&lt;/div&gt;`;
                    }
                }
                celdas += `&lt;td class=&quot;celda-perfil ${cl}&quot;&gt;${txt}&lt;/td&gt;`;
            }

            const fMod = d.ultimaModificacion ? new Date(d.ultimaModificacion).toLocaleString('es-CO', {hour12:true, month:'short', day:'numeric', hour:'numeric', minute:'numeric'}) : '---';

            const row = document.createElement(&quot;tr&quot;);
            let btnBorrar = (body === tablas['OTROS']) ? `&lt;button class=&quot;delete-btn&quot; onclick=&quot;eliminarCuentaGenerica('${id}', '${colOrigen}')&quot; style=&quot;background:none; border:none; cursor:pointer;&quot;&gt;üóëÔ∏è&lt;/button&gt;` : &quot;&quot;;
            let colPlataforma = (body === tablas['OTROS']) ? `&lt;td&gt;&lt;b&gt;${d.plataforma}&lt;/b&gt;&lt;/td&gt;` : &quot;&quot;;

            row.innerHTML = `
                ${colPlataforma}
                &lt;td&gt;&lt;input type=&quot;text&quot; value=&quot;${d.correo}&quot; id=&quot;edit-cor-${id}&quot; class=&quot;input-locked&quot; readonly&gt;&lt;/td&gt;
                &lt;td&gt;&lt;input type=&quot;text&quot; value=&quot;${d.clave}&quot; id=&quot;edit-cla-${id}&quot; class=&quot;input-locked&quot; readonly&gt;&lt;/td&gt;
                ${celdas}
                &lt;td style=&quot;font-size:13px; color:gray;&quot;&gt;${fMod}&lt;/td&gt;
                &lt;td id=&quot;td-accion-${id}&quot; style=&quot;white-space:nowrap;&quot;&gt;
                    &lt;button class=&quot;edit-btn&quot; onclick=&quot;habilitarEdicionFila('${id}', '${colOrigen}')&quot;&gt;‚úèÔ∏è&lt;/button&gt;
                    ${btnBorrar}
                &lt;/td&gt;
            `;
            body.appendChild(row);
        });
    } catch (e) { console.error(&quot;Error:&quot;, e); }
}

// ESTA FUNCI√ìN ES LA QUE CAMBIA EL L√ÅPIZ POR EL DISCO DE GUARDAR
function habilitarEdicionFila(id, coleccion) {
    let inputCor = document.getElementById(&quot;edit-cor-&quot; + id);
    let inputCla = document.getElementById(&quot;edit-cla-&quot; + id);
    let tdAccion = document.getElementById(&quot;td-accion-&quot; + id);

    if (!inputCor || !inputCla) return;

    // 1. DESBLOQUEO DE TECLADO Y MOUSE
    inputCor.readOnly = false;
    inputCla.readOnly = false;

    // 2. ESTILO DE CAJ√ìN ABIERTO
    // El 'cursor: text' es vital para que el mouse te deje seleccionar letras
    let estiloEditable = &quot;background:#fff !important; border:2px solid #25d366 !important; color:#000 !important; cursor:text !important; pointer-events: auto !important;&quot;;
    
    inputCor.setAttribute(&quot;style&quot;, estiloEditable);
    inputCla.setAttribute(&quot;style&quot;, estiloEditable);

    // 3. CAMBIO DE BOTONES
    tdAccion.innerHTML = `
        &lt;button onclick=&quot;guardarCambiosCompletos('${id}', '${coleccion}')&quot; style=&quot;background:#25d366; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;&quot;&gt;üíæ&lt;/button&gt;
        &lt;button onclick=&quot;cargarAdminPerfiles()&quot; style=&quot;background:#e74c3c; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; margin-left:5px;&quot;&gt;‚úñ&lt;/button&gt;
    `;

    // 4. AUTO-SELECCI√ìN (Opcional pero recomendado)
    // Esto hace que al darle al l√°piz, ya quede sombreada la clave para borrarla de una
    inputCla.select(); 
}

// Para que los botones siempre encuentren la funci√≥n
window.habilitarEdicionFila = habilitarEdicionFila;

async function guardarCambiosCompletos(id, coleccion) {
    let nCor = document.getElementById(&quot;edit-cor-&quot; + id).value;
    let nCla = document.getElementById(&quot;edit-cla-&quot; + id).value;
    
    // Guardamos en formato ISO (Est√°ndar universal)
    let fechaISO = new Date().toISOString();

    try {
        await db.collection(coleccion).doc(id).update({
            correo: nCor,
            clave: nCla,
            ultimaModificacion: fechaISO
        });
        alert(&quot;‚úÖ Guardado con √©xito&quot;);
    
        cargarAdminPerfiles(); 
        
        // --- ESTO ES LO QUE DEBES AGREGAR ---
        // 1. Si est√°s en la misma p√°gina de Admin Perfiles, refresca esa tabla
        if (typeof cargarAdminPerfiles === 'function') {
            await cargarAdminPerfiles();
        }

        // 2. Si tienes la tabla de Historial/Ventas en la misma pantalla, la refrescamos
        // Suponiendo que tu funci√≥n de historial se llama 'cargarHistorialVentas'
        if (typeof cargarHistorialVentas === 'function') {
            await cargarHistorialVentas();
        }
        
    } catch (e) {
        alert(&quot;‚ùå Error al guardar&quot;);
    }
    
    
}

async function actualizarCuentaBase(id) {
    // 1. Capturamos lo que escribiste en los cajones
    const elCor = document.getElementById(`edit-cor-${id}`);
    const elCla = document.getElementById(`edit-cla-${id}`);
    
    if (!elCor || !elCla) return;

    const nuevoCor = elCor.value.trim(); 
    const nuevaCla = elCla.value.trim();
    const ahora = new Date().toISOString();

    try {
        // 2. OBTENEMOS LOS DATOS ACTUALES (Antes de guardar el cambio)
        // Esto es para saber qu√© correo tienen los clientes ahora mismo
        const refMaestra = db.collection(&quot;cuentas_base&quot;).doc(id);
        const snapMaestro = await refMaestra.get();
        
        if (!snapMaestro.exists) return;

        // Guardamos el correo y plataforma que ya estaban en la DB
        const correoParaBuscar = snapMaestro.data().correo.trim();
        const plataformaActual = snapMaestro.data().plataforma;

        // 3. ACTUALIZAR LA CUENTA EN CUENTAS_BASE
        await refMaestra.update({
            correo: nuevoCor,
            clave: nuevaCla,
            ultimaModificacion: ahora
        });

        // 4. SINCRONIZACI√ìN AUTOM√ÅTICA CON LA COLECCI√ìN &quot;CUENTAS&quot;
        // Buscamos a todos los clientes que tengan el correo viejo
        const snapClientes = await db.collection(&quot;cuentas&quot;)
            .where(&quot;correo&quot;, &quot;==&quot;, correoParaBuscar)
            .get();

        if (!snapClientes.empty) {
            const batch = db.batch();
            let sincronizados = 0;

            snapClientes.forEach(docC =&gt; {
                // Filtramos por plataforma para seguridad
                if (docC.data().plataforma === plataformaActual) {
                    batch.update(docC.ref, {
                        correo: nuevoCor, // Si cambiaste el correo, tambi√©n se les cambia a ellos
                        clave: nuevaCla,
                        ultimaModificacion: ahora
                    });
                    sincronizados++;
                }
            });

            await batch.commit();
            console.log(&quot;Sincronizaci√≥n terminada: &quot; + sincronizados + &quot; clientes actualizados.&quot;);
        }

        alert(&quot;‚úÖ ¬°Excelente! Se actualiz√≥ cuentas_base y se sincroniz√≥ con la colecci√≥n cuentas.&quot;);
        
        // 5. REFRESCAR LA P√ÅGINA (Para que veas el cambio en tu tabla)
        if (typeof cargarAdminPerfiles === 'function') {
            await cargarAdminPerfiles();
        }

    } catch (error) {
        console.error(&quot;Error en la sincronizaci√≥n:&quot;, error);
        alert(&quot;‚ùå Error al guardar: &quot; + error.message);
    }
}

// Hacer la funci√≥n global para el onclick
window.actualizarCuentaBase = actualizarCuentaBase;

async function guardarCambiosCompletos(id, coleccion) {
    // 1. Capturamos los datos que escribiste en los cajones de Admin Perfiles
    const inputCor = document.getElementById(&quot;edit-cor-&quot; + id);
    const inputCla = document.getElementById(&quot;edit-cla-&quot; + id);
    
    if (!inputCor || !inputCla) return;

    const nuevoCor = inputCor.value.trim(); 
    const nuevaCla = inputCla.value.trim();
    const ahora = new Date().toISOString();

    try {
        // 2. BUSCAMOS EL CORREO ACTUAL EN CUENTAS_BASE (Antes de cambiarlo)
        // Lo necesitamos para saber a qu√© clientes buscar en la otra tabla
        const refMaestra = db.collection(&quot;cuentas_base&quot;).doc(id);
        const snapMaestro = await refMaestra.get();
        
        if (!snapMaestro.exists) return;
        const correoBusqueda = snapMaestro.data().correo.trim();

        // 3. ACTUALIZAMOS CUENTAS_BASE (Lo que ya te funciona bien)
        await refMaestra.update({
            correo: nuevoCor,
            clave: nuevaCla,
            ultimaModificacion: ahora
        });

        // 4. EL ENLACE: ACTUALIZAR LA COLECCI√ìN &quot;CUENTAS&quot; (Los clientes)
        // Buscamos a todos los clientes que tengan el correo que acabamos de editar
        const snapClientes = await db.collection(&quot;cuentas&quot;)
            .where(&quot;correo&quot;, &quot;==&quot;, correoBusqueda)
            .get();

        if (!snapClientes.empty) {
            const batch = db.batch();
            
            snapClientes.forEach(docC =&gt; {
                // A cada cliente encontrado le actualizamos su clave y correo
                batch.update(docC.ref, {
                    correo: nuevoCor,
                    clave: nuevaCla,
                    ultimaModificacion: ahora
                });
            });

            // Se ejecutan todos los cambios de los clientes de un solo golpe
            await batch.commit();
            console.log(&quot;Sincronizaci√≥n con clientes exitosa&quot;);
        }

        alert(&quot;‚úÖ Guardado en cuentas_base y actualizado en cuentas de clientes.&quot;);
        
        // 5. Refrescamos la tabla que est√°s viendo
        if (typeof cargarAdminPerfiles === 'function') {
            await cargarAdminPerfiles();
        }

    } catch (error) {
        console.error(&quot;Error sincronizando:&quot;, error);
        alert(&quot;‚ùå Error al enlazar con clientes: &quot; + error.message);
    }
}

// Hacer la funci√≥n disponible para el bot√≥n
window.guardarCambiosCompletos = guardarCambiosCompletos;

async function eliminarCuentaGenerica(id, coleccion) {
    // Mensaje de verificaci√≥n
    const confirmar = confirm(&quot;‚ö† ¬øEst√°s seguro de que deseas eliminar esta cuenta? Esta acci√≥n no se puede deshacer.&quot;);
    
    if (confirmar) {
        try {
            await db.collection(coleccion).doc(id).delete();
            alert(&quot;üóë Cuenta eliminada con √©xito&quot;);
            cargarAdminPerfiles(); // Refresca la tabla autom√°ticamente
        } catch (error) {
            console.error(&quot;Error al eliminar:&quot;, error);
            alert(&quot;‚ùå No se pudo eliminar la cuenta&quot;);
        }
    }
}


// -------------------------------------------------------------------------
// FUNCIONES DE SINCRONIZACI√ìN (LA L√ìGICA QUE AGREGU√â PARA TI)
// -------------------------------------------------------------------------




function mostrarTooltip(e) {
    const info = e.currentTarget.getAttribute('data-info');
    if (info) {
        tooltip.innerHTML = info;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
    }
}

function ocultarTooltip() { tooltip.style.display = 'none'; }



async function actualizarCuentaBase(idCuenta) {
    try {
        const nuevoCorreo = document.getElementById(`edit-cor-${idCuenta}`).value.trim();
        const nuevaClave = document.getElementById(`edit-cla-${idCuenta}`).value.trim();
        const ahora = new Date().toISOString();

        // 1. Actualizar CUENTA BASE
        await db.collection(&quot;cuentas_base&quot;).doc(idCuenta).update({
            correo: nuevoCorreo,
            clave: nuevaClave,
            ultimaModificacion: ahora
        });

        // 2. Actualizaci√≥n EN CASCADA usando ID (NO correo)
        const snap = await db.collection(&quot;cuentas&quot;)
            .where(&quot;idReferenciaBase&quot;, &quot;==&quot;, idCuenta)
            .get();

        if (!snap.empty) {
            const batch = db.batch();

            snap.forEach(doc =&gt; {
                batch.update(doc.ref, {
                    correo: nuevoCorreo,
                    clave: nuevaClave,
                    ultimaModificacion: ahora
                });
            });

            await batch.commit();
        }

        alert(&quot;‚úÖ Cuenta y clientes sincronizados correctamente.&quot;);
        actualizarTodo();

    } catch (e) {
        console.error(e);
        alert(&quot;‚ùå Error al sincronizar: &quot; + e.message);
    }
}

async function eliminarCuentaBase(id) {
    if (confirm(&quot;¬øEliminar esta cuenta base?&quot;)) {
        await db.collection(&quot;cuentas_base&quot;).doc(id).delete();
        actualizarTodo();
    }
}

function abrirModalNuevaCuenta(plat) {
    const correo = prompt(`Correo para ${plat}:`);
    if (!correo) return;
    const clave = prompt(`Clave:`);
    db.collection(&quot;cuentas_base&quot;).add({ plataforma: plat, correo: correo, clave: clave, ultimaModificacion: Date.now() }).then(() =&gt; actualizarTodo());
}document.addEventListener(&quot;DOMContentLoaded&quot;, function() {
    // Esto precarga los datos en memoria apenas abre la web
    cargarCuentasBase();
});

// --- ANULADOR DE BLOQUEOS ---
// Forzamos que cualquier intento de abrir el editor manual use nuestra nueva l√≥gica
window.abrirEditorManualLote = function(id) {
    console.log(&quot;Anulando funci√≥n vieja... Abriendo cargador nuevo para ID:&quot;, id);
    cargarParaModificar(id); // Redirige a la funci√≥n que S√ç funciona
};

// Si tienes un bot√≥n que llama a otra cosa, esto lo redireccionar√°
window.editarCuentaSuscripcion = function(id) {
    cargarParaModificar(id);
    window.habilitarEdicionFila = habilitarEdicionFila;
window.guardarCambiosCompletos = guardarCambiosCompletos;
window.eliminarCuentaGenerica = eliminarCuentaGenerica;
window.habilitarEdicionFila = habilitarEdicionFila;
window.guardarCambiosCompletos = guardarCambiosCompletos;
};

&lt;/script&gt; 
&lt;/body&gt;
&lt;/html&gt;" title="Panel MultiBC" style="width:100%; height:100vh; border:none;""></iframe></body>

</html>
